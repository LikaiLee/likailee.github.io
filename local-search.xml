<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>å¹¶å‘-å®¹å™¨</title>
    <link href="/2020/07/24/concurrent-container/"/>
    <url>/2020/07/24/concurrent-container/</url>
    
    <content type="html"><![CDATA[<h1 id="åŒæ­¥å®¹å™¨"><a href="#åŒæ­¥å®¹å™¨" class="headerlink" title="åŒæ­¥å®¹å™¨"></a>åŒæ­¥å®¹å™¨</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>åœ¨ <code>Java</code> ä¸­ï¼ŒåŒæ­¥å®¹å™¨ä¸»è¦åŒ…æ‹¬ <code>2</code> ç±»ï¼š</p><ul><li><p><code>Vector</code>, <code>Stack</code>, <code>HashTable</code></p><ul><li><code>Vector</code> - <code>Vector</code> å®ç°äº† <code>List</code> æ¥å£ã€‚<code>Vector</code> å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå’Œ <code>ArrayList</code> ç±»ä¼¼ã€‚ä½†æ˜¯ <code>Vector</code> ä¸­çš„æ–¹æ³•éƒ½æ˜¯ <code>synchronized</code> æ–¹æ³•ï¼Œå³è¿›è¡Œäº†åŒæ­¥æªæ–½ã€‚</li><li><code>Stack</code> - <code>Stack</code> ç»§æ‰¿äº <code>Vector</code> ç±»ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåŒæ­¥å®¹å™¨ï¼Œå®ƒçš„æ–¹æ³•ä¹Ÿç”¨ <code>synchronized</code> è¿›è¡Œäº†åŒæ­¥ã€‚</li><li><code>Hashtable</code>- <code>Hashtable</code> å®ç°äº† <code>Map</code> æ¥å£ï¼Œä½†æ˜¯ <code>Hashtable</code> ç”¨ <code>synchronized</code> è¿›è¡Œäº†åŒæ­¥ã€‚</li></ul></li><li><p><code>Collections</code> ç±»ä¸­æä¾›çš„é™æ€å·¥å‚æ–¹æ³•åˆ›å»ºçš„ç±»ï¼ˆç”± <code>Collections.synchronizedXXX</code> ç­‰æ–¹æ³•ï¼‰ã€‚</p></li></ul><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>åŒæ­¥å®¹å™¨çš„åŒæ­¥åŸç†å°±æ˜¯åœ¨æ–¹æ³•ä¸Šç”¨ <code>synchronized</code> ä¿®é¥°ã€‚</p><h3 id="æ€§èƒ½é—®é¢˜"><a href="#æ€§èƒ½é—®é¢˜" class="headerlink" title="æ€§èƒ½é—®é¢˜"></a>æ€§èƒ½é—®é¢˜</h3><p><code>synchronized</code> çš„äº’æ–¥åŒæ­¥ä¼šäº§ç”Ÿé˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„å¼€é”€ã€‚æ˜¾ç„¶ï¼Œè¿™ç§æ–¹å¼æ¯”æ²¡æœ‰ä½¿ç”¨ <code>synchronized</code> çš„å®¹å™¨æ€§èƒ½è¦å·®ã€‚</p><h3 id="å®‰å…¨é—®é¢˜"><a href="#å®‰å…¨é—®é¢˜" class="headerlink" title="å®‰å…¨é—®é¢˜"></a>å®‰å…¨é—®é¢˜</h3><p>åŒæ­¥å®¹å™¨çœŸçš„ç»å¯¹å®‰å…¨å—ï¼Ÿ</p><p>å…¶å®ä¹Ÿæœªå¿…ã€‚åœ¨åšå¤åˆæ“ä½œï¼ˆéåŸå­æ“ä½œï¼‰æ—¶ï¼Œä»ç„¶éœ€è¦åŠ é”æ¥ä¿æŠ¤ã€‚å¸¸è§å¤åˆæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li><p>è¿­ä»£ï¼šåå¤è®¿é—®å…ƒç´ ï¼Œç›´åˆ°éå†å®Œå…¨éƒ¨å…ƒç´ ï¼›</p></li><li><p>è·³è½¬ï¼šæ ¹æ®æŒ‡å®šé¡ºåºå¯»æ‰¾å½“å‰å…ƒç´ çš„ä¸‹ä¸€ä¸ªï¼ˆä¸‹ <code>n</code> ä¸ªï¼‰å…ƒç´ ï¼›</p></li><li><p>æ¡ä»¶è¿ç®—ï¼šä¾‹å¦‚è‹¥æ²¡æœ‰åˆ™æ·»åŠ ç­‰ï¼›</p></li></ul><p>âŒ ä¸å®‰å…¨çš„ç¤ºä¾‹</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> likailee.llk</span><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> : ConcurrentContainerTest.java 2020/07/24 Fri 1:56 PM likai</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcurrentContainerTest</span> </span>&#123;    <span class="hljs-keyword">static</span> Vector&lt;Integer&gt; vector = <span class="hljs-keyword">new</span> Vector&lt;&gt;();    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;            vector.clear();            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;                vector.add(i);            &#125;            Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++) &#123;                    vector.remove(i);                &#125;            &#125;);            Thread t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++) &#123;                    vector.get(i);                &#125;            &#125;);            t1.start();            t2.start();            <span class="hljs-keyword">while</span> (Thread.activeCount() &gt; <span class="hljs-number">10</span>) &#123;                System.out.println(<span class="hljs-string">"åŒæ—¶å­˜åœ¨åä¸ªä»¥ä¸Šçº¿ç¨‹ï¼Œ é€€å‡º"</span>);                <span class="hljs-keyword">return</span>;            &#125;        &#125;    &#125;&#125;</code></pre><p>ä»¥ä¸Šç¨‹åºæ‰§è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°æ•°ç»„è¶Šç•Œé”™è¯¯ã€‚</p><p>è¿™æ˜¯å› ä¸ºï¼Œå¯¹äº <code>Vector</code>ï¼Œè™½ç„¶èƒ½ä¿è¯æ¯ä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å®ƒï¼Œä½†æ˜¯ä¸æ’é™¤è¿™ç§å¯èƒ½ï¼š<br>å½“æŸä¸ªçº¿ç¨‹è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»åˆ é™¤äº†è¯¥çº¿ç¨‹æ‰€è¦è¯»çš„é‚£ä¸ªå…ƒç´ ã€‚</p><p>å› æ­¤ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¿…é¡»åœ¨æ–¹æ³•è°ƒç”¨ç«¯åšé¢å¤–çš„åŒæ­¥æªæ–½ï¼Œå¦‚ä¸‹é¢æ‰€ç¤ºï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (vector) &#123;    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++) &#123;        vector.remove(i);    &#125;&#125;<span class="hljs-keyword">synchronized</span> (vector) &#123;    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++) &#123;        vector.remove(i);    &#125;&#125;</code></pre><h1 id="å¹¶å‘å®¹å™¨ç®€ä»‹"><a href="#å¹¶å‘å®¹å™¨ç®€ä»‹" class="headerlink" title="å¹¶å‘å®¹å™¨ç®€ä»‹"></a>å¹¶å‘å®¹å™¨ç®€ä»‹</h1><blockquote><p>åŒæ­¥å®¹å™¨å°†æ‰€æœ‰å¯¹å®¹å™¨çŠ¶æ€çš„è®¿é—®éƒ½ä¸²è¡ŒåŒ–ï¼Œä»¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œè¿™ç§ç­–ç•¥ä¼šä¸¥é‡é™ä½å¹¶å‘æ€§ã€‚</p><p>Java 1.5 åæä¾›äº†å¤šç§å¹¶å‘å®¹å™¨ï¼Œä½¿ç”¨å¹¶å‘å®¹å™¨æ¥æ›¿ä»£åŒæ­¥å®¹å™¨ï¼Œå¯ä»¥æå¤§åœ°æé«˜ä¼¸ç¼©æ€§å¹¶é™ä½é£é™©ã€‚</p></blockquote><p>J.U.C åŒ…ä¸­æä¾›äº†å‡ ä¸ªéå¸¸æœ‰ç”¨çš„å¹¶å‘å®¹å™¨ä½œä¸ºçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼š</p><table><thead><tr><th align="center">å¹¶å‘å®¹å™¨</th><th align="center">å¯¹åº”çš„æ™®é€šå®¹å™¨</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center"><code>ConcurrentHashMap</code></td><td align="center"><code>HashMap</code></td><td align="center"><code>Java 1.8</code> ä¹‹å‰é‡‡ç”¨<strong>åˆ†æ®µé”æœºåˆ¶</strong>ç»†åŒ–é”ç²’åº¦ï¼Œé™ä½é˜»å¡ï¼Œä»è€Œæé«˜å¹¶å‘æ€§ï¼›<code>Java 1.8</code> ä¹‹ååŸºäº <code>CAS</code> å®ç°ã€‚</td></tr><tr><td align="center"><code>ConcurrentSkipListMap</code></td><td align="center"><code>SortedMap</code></td><td align="center">åŸºäºè·³è¡¨å®ç°çš„</td></tr><tr><td align="center"><code>CopyOnWriteArrayList</code></td><td align="center"><code>ArrayList</code></td><td align="center">å†™æ—¶å¤åˆ¶</td></tr><tr><td align="center"><code>CopyOnWriteArraySet</code></td><td align="center"><code>Set</code></td><td align="center">åŸºäº <code>CopyOnWriteArrayList</code> å®ç°ã€‚</td></tr><tr><td align="center"><code>ConcurrentSkipListSet</code></td><td align="center"><code>SortedSet</code></td><td align="center">åŸºäº <code>ConcurrentSkipListMap</code> å®ç°ã€‚</td></tr><tr><td align="center"><code>ConcurrentLinkedQueue</code></td><td align="center"><code>Queue</code></td><td align="center">çº¿ç¨‹å®‰å…¨çš„æ— ç•Œé˜Ÿåˆ—ã€‚åº•å±‚é‡‡ç”¨å•é“¾è¡¨ã€‚æ”¯æŒ <code>FIFO</code>ã€‚</td></tr><tr><td align="center"><code>ConcurrentLinkedDeque</code></td><td align="center"><code>Deque</code></td><td align="center">çº¿ç¨‹å®‰å…¨çš„æ— ç•ŒåŒç«¯é˜Ÿåˆ—ã€‚åº•å±‚é‡‡ç”¨åŒå‘é“¾è¡¨ã€‚æ”¯æŒ <code>FIFO</code> å’Œ <code>FILO</code>ã€‚</td></tr><tr><td align="center"><code>ArrayBlockingQueue</code></td><td align="center"><code>Queue</code></td><td align="center">æ•°ç»„å®ç°çš„é˜»å¡é˜Ÿåˆ—ã€‚</td></tr><tr><td align="center"><code>LinkedBlockingQueue</code></td><td align="center"><code>Queue</code></td><td align="center">é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ã€‚</td></tr><tr><td align="center"><code>LinkedBlockingDeque</code></td><td align="center"><code>Deque</code></td><td align="center">åŒå‘é“¾è¡¨å®ç°çš„åŒç«¯é˜»å¡é˜Ÿåˆ—ã€‚</td></tr></tbody></table><h1 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a><code>ConcurrentHashMap</code></h1><blockquote><p><code>ConcurrentHashMap</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ <code>HashMap</code> ï¼Œç”¨äºæ›¿ä»£ <code>Hashtable</code>ã€‚</p></blockquote><h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><p><code>ConcurrentHashMap</code> å®ç°äº† <code>ConcurrentMap</code> æ¥å£ï¼Œè€Œ <code>ConcurrentMap</code> æ¥å£æ‰©å±•äº† <code>Map</code> æ¥å£ã€‚</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcurrentHashMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;</span><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">ConcurrentMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;, <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-comment">// ...</span>&#125;</code></pre><p><code>ConcurrentHashMap</code> çš„å®ç°åŒ…å«äº† <code>HashMap</code> æ‰€æœ‰çš„åŸºæœ¬ç‰¹æ€§ï¼Œå¦‚ï¼šæ•°æ®ç»“æ„ã€è¯»å†™ç­–ç•¥ç­‰ã€‚</p><p><code>ConcurrentHashMap</code> æ²¡æœ‰å®ç°å¯¹ <code>Map</code> åŠ é”ä»¥æä¾›ç‹¬å è®¿é—®ã€‚å› æ­¤æ— æ³•é€šè¿‡åœ¨å®¢æˆ·ç«¯åŠ é”çš„æ–¹å¼æ¥åˆ›å»ºæ–°çš„åŸå­æ“ä½œã€‚ä½†æ˜¯ï¼Œä¸€äº›å¸¸è§çš„å¤åˆæ“ä½œï¼Œå¦‚ï¼šâ€œè‹¥æ²¡æœ‰åˆ™æ·»åŠ â€ã€â€œè‹¥ç›¸ç­‰åˆ™ç§»é™¤â€ã€â€œè‹¥ç›¸ç­‰åˆ™æ›¿æ¢â€ï¼Œéƒ½å·²ç»å®ç°ä¸ºåŸå­æ“ä½œï¼Œå¹¶ä¸”æ˜¯å›´ç»• <code>ConcurrentMap</code> çš„æ‰©å±•æ¥å£è€Œå®ç°ã€‚</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ConcurrentMap</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>&#123;    <span class="hljs-comment">// ä»…å½“ K æ²¡æœ‰ç›¸åº”çš„æ˜ å°„å€¼æ‰æ’å…¥</span>    <span class="hljs-function">V <span class="hljs-title">putIfAbsent</span><span class="hljs-params">(K key, V value)</span></span>;    <span class="hljs-comment">// ä»…å½“ K è¢«æ˜ å°„åˆ° V æ—¶æ‰ç§»é™¤</span>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">remove</span><span class="hljs-params">(Object key, Object value)</span></span>;    <span class="hljs-comment">// ä»…å½“ K è¢«æ˜ å°„åˆ° oldValue æ—¶æ‰æ›¿æ¢ä¸º newValue</span>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">replace</span><span class="hljs-params">(K key, V oldValue, V newValue)</span></span>;    <span class="hljs-comment">// ä»…å½“ K è¢«æ˜ å°„åˆ°æŸä¸ªå€¼æ—¶æ‰æ›¿æ¢ä¸º newValue</span>    <span class="hljs-function">V <span class="hljs-title">replace</span><span class="hljs-params">(K key, V value)</span></span>;&#125;</code></pre><p>ä¸åŒäº <code>Hashtable</code>ï¼Œ<code>ConcurrentHashMap</code> æä¾›çš„è¿­ä»£å™¨ä¸ä¼šæŠ›å‡º <code>ConcurrentModificationException</code>ï¼Œå› æ­¤ä¸éœ€è¦åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å¯¹å®¹å™¨åŠ é”ã€‚</p><blockquote><p>ğŸ”” æ³¨æ„ï¼šä¸€äº›éœ€è¦å¯¹æ•´ä¸ª <code>Map</code> è¿›è¡Œè®¡ç®—çš„æ–¹æ³•ï¼Œå¦‚ <code>size</code> å’Œ <code>isEmpty</code> ï¼Œç”±äºè¿”å›çš„ç»“æœåœ¨è®¡ç®—æ—¶å¯èƒ½å·²ç»è¿‡æœŸï¼Œæ‰€ä»¥å¹¶éå®æ—¶çš„ç²¾ç¡®å€¼ã€‚è¿™æ˜¯ä¸€ç§ç­–ç•¥ä¸Šçš„æƒè¡¡ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œè¿™ç±»æ–¹æ³•ç”±äºæ€»åœ¨ä¸æ–­å˜åŒ–ï¼Œæ‰€ä»¥è·å–å…¶å®æ—¶ç²¾ç¡®å€¼çš„æ„ä¹‰ä¸å¤§ã€‚<code>ConcurrentHashMap</code> å¼±åŒ–è¿™ç±»æ–¹æ³•ï¼Œä»¥æ¢å–æ›´é‡è¦æ“ä½œï¼ˆå¦‚ï¼š<code>get</code>ã€<code>put</code>ã€<code>containesKey</code>ã€<code>remove</code> ç­‰ï¼‰çš„æ€§èƒ½ã€‚</p></blockquote><h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p>åŒ <code>HashMap</code></p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><code>ConcurrentHashMap</code> åœ¨ <code>Java 1.8</code> ä¹‹å‰å’Œ <code>Java 1.8</code> ä¹‹åçš„å®ç°æœ‰å¾ˆå¤§å·®å¼‚ï¼š</p><ul><li><code>Java 1.8</code> ä¹‹å‰é‡‡ç”¨<strong>åˆ†æ®µé”æœºåˆ¶</strong>ç»†åŒ–é”ç²’åº¦ï¼Œé™ä½é˜»å¡ï¼Œä»è€Œæé«˜å¹¶å‘æ€§ã€‚</li><li><code>Java 1.8</code> ä¹‹ååŸºäº <code>CAS</code> å®ç°ã€‚</li></ul><h3 id="Java-1-7-çš„å®ç°"><a href="#Java-1-7-çš„å®ç°" class="headerlink" title="Java 1.7 çš„å®ç°"></a>Java 1.7 çš„å®ç°</h3><p>æ¯ä¸€ä¸ª <code>segment</code> éƒ½æ˜¯ä¸€ä¸ª <code>HashEntry&lt;K,V&gt;[] table</code>ï¼Œ <code>table</code> ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ª <code>HashEntry</code> çš„å•å‘é˜Ÿåˆ—ã€‚æ¯”å¦‚ <code>table[3]</code> ä¸ºé¦–èŠ‚ç‚¹ï¼Œ<code>table[3]-&gt;next</code> ä¸ºèŠ‚ç‚¹ <code>1</code>ï¼Œä¹‹åä¸ºèŠ‚ç‚¹ <code>2</code>ï¼Œä¾æ¬¡ç±»æ¨ã€‚</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcurrentHashMap</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMap</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt;</span><span class="hljs-class">        <span class="hljs-keyword">implements</span> <span class="hljs-title">ConcurrentMap</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt;, <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-comment">// å°†æ•´ä¸ª hashmap åˆ†æˆå‡ ä¸ªå°çš„ mapï¼Œæ¯ä¸ª segment éƒ½æ˜¯ä¸€ä¸ªé”ï¼›ä¸ hashtable ç›¸æ¯”ï¼Œè¿™ä¹ˆè®¾è®¡çš„ç›®çš„æ˜¯å¯¹äº put, remove ç­‰æ“ä½œï¼Œå¯ä»¥å‡å°‘å¹¶å‘å†²çªï¼Œå¯¹</span>    <span class="hljs-comment">// ä¸å±äºåŒä¸€ä¸ªç‰‡æ®µçš„èŠ‚ç‚¹å¯ä»¥å¹¶å‘æ“ä½œï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½</span>    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments;    <span class="hljs-comment">// æœ¬è´¨ä¸Š Segment ç±»å°±æ˜¯ä¸€ä¸ªå°çš„ hashmapï¼Œé‡Œé¢ table æ•°ç»„å­˜å‚¨äº†å„ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼Œç»§æ‰¿äº† ReentrantLock, å¯ä»¥ä½œä¸ºäº’æ–¥é”ä½¿ç”¨</span>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Segment</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;        <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;        <span class="hljs-keyword">transient</span> <span class="hljs-keyword">int</span> count;    &#125;    <span class="hljs-comment">// åŸºæœ¬èŠ‚ç‚¹ï¼Œå­˜å‚¨ Key, Value å€¼</span>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HashEntry</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; </span>&#123;        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> hash;        <span class="hljs-keyword">final</span> K key;        <span class="hljs-keyword">volatile</span> V value;        <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt; next;    &#125;&#125;</code></pre><h3 id="Java-1-8-çš„å®ç°"><a href="#Java-1-8-çš„å®ç°" class="headerlink" title="Java 1.8 çš„å®ç°"></a>Java 1.8 çš„å®ç°</h3><p><code>JDK 8</code> ä¸­ä¸»è¦åšäº† 2 æ–¹é¢çš„æ”¹è¿›</p><ul><li><p>å–æ¶ˆ <code>segments</code> å­—æ®µï¼Œç›´æ¥é‡‡ç”¨ <code>transient volatile HashEntry&lt;K,V&gt;[] table</code> ä¿å­˜æ•°æ®ï¼Œé‡‡ç”¨ <code>table</code> æ•°ç»„å…ƒç´ ä½œä¸ºé”ï¼Œä»è€Œå®ç°äº†å¯¹æ¯ä¸€è¡Œæ•°æ®è¿›è¡ŒåŠ é”ï¼Œè¿›ä¸€æ­¥å‡å°‘å¹¶å‘å†²çªçš„æ¦‚ç‡ã€‚</p></li><li><p>å°†åŸå…ˆ <strong>æ•°ç»„ï¼‹å•é“¾è¡¨</strong> çš„æ•°æ®ç»“æ„ï¼Œå˜æ›´ä¸º <strong>æ•°ç»„ï¼‹å•é“¾è¡¨ï¼‹çº¢é»‘æ ‘</strong> çš„ç»“æ„ã€‚å¯¹äº <code>hash</code> è¡¨æ¥è¯´ï¼Œæœ€æ ¸å¿ƒçš„èƒ½åŠ›åœ¨äºå°† <code>key hash</code> ä¹‹åèƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨æ•°ç»„ä¸­ã€‚å¦‚æœ <code>hash</code> ä¹‹åæ•£åˆ—çš„å¾ˆå‡åŒ€ï¼Œé‚£ä¹ˆ <code>table</code> æ•°ç»„ä¸­çš„æ¯ä¸ªé˜Ÿåˆ—é•¿åº¦ä¸»è¦ä¸º <code>0</code> æˆ–è€… <code>1</code>ã€‚ä½†å®é™…æƒ…å†µå¹¶éæ€»æ˜¯å¦‚æ­¤ç†æƒ³ï¼Œè™½ç„¶ <code>ConcurrentHashMap</code> ç±»é»˜è®¤çš„åŠ è½½å› å­ä¸º <code>0.75</code>ï¼Œä½†æ˜¯åœ¨æ•°æ®é‡è¿‡å¤§æˆ–è€…è¿æ°”ä¸ä½³çš„æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨ä¸€äº›é˜Ÿåˆ—é•¿åº¦è¿‡é•¿çš„æƒ…å†µï¼Œå¦‚æœè¿˜æ˜¯é‡‡ç”¨å•å‘åˆ—è¡¨æ–¹å¼ï¼Œé‚£ä¹ˆæŸ¥è¯¢æŸä¸ªèŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦ä¸º <code>O(n)</code>ï¼›å› æ­¤ï¼Œå¯¹äºä¸ªæ•°è¶…è¿‡ <code>8</code>(é»˜è®¤å€¼)çš„åˆ—è¡¨ï¼Œ<code>JDK 1.8</code> ä¸­é‡‡ç”¨äº†çº¢é»‘æ ‘çš„ç»“æ„ï¼Œé‚£ä¹ˆæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ° <code>O(logN)</code>ï¼Œå¯ä»¥æ”¹è¿›æ€§èƒ½ã€‚</p></li></ul><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">final</span> V <span class="hljs-title">putVal</span><span class="hljs-params">(K key, V value, <span class="hljs-keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;    <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span> || value == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();    <span class="hljs-keyword">int</span> hash = spread(key.hashCode());    <span class="hljs-keyword">int</span> binCount = <span class="hljs-number">0</span>;    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;        Node&lt;K,V&gt; f; <span class="hljs-keyword">int</span> n, i, fh;        <span class="hljs-comment">// å¦‚æœ table ä¸ºç©ºï¼Œåˆå§‹åŒ–ï¼›å¦åˆ™ï¼Œæ ¹æ® hash å€¼è®¡ç®—å¾—åˆ°æ•°ç»„ç´¢å¼•iï¼Œå¦‚æœ tab[i] ä¸ºç©ºï¼Œç›´æ¥æ–°å»ºèŠ‚ç‚¹ Node å³å¯ã€‚æ³¨ï¼štab[i] å®è´¨ä¸ºé“¾è¡¨æˆ–è€…çº¢é»‘æ ‘çš„é¦–èŠ‚ç‚¹ã€‚</span>        <span class="hljs-keyword">if</span> (tab == <span class="hljs-keyword">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)            tab = initTable();        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-keyword">null</span>,                         <span class="hljs-keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="hljs-keyword">null</span>)))                <span class="hljs-keyword">break</span>;                   <span class="hljs-comment">// no lock when adding to empty bin</span>        &#125;        <span class="hljs-comment">// å¦‚æœ tab[i] ä¸ä¸ºç©ºå¹¶ä¸” hash å€¼ä¸º MOVEDï¼Œè¯´æ˜è¯¥é“¾è¡¨æ­£åœ¨è¿›è¡Œ transfer æ“ä½œï¼Œè¿”å›æ‰©å®¹å®Œæˆåçš„ tableã€‚</span>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)            tab = helpTransfer(tab, f);        <span class="hljs-keyword">else</span> &#123;            V oldVal = <span class="hljs-keyword">null</span>;            <span class="hljs-comment">// é’ˆå¯¹é¦–ä¸ªèŠ‚ç‚¹è¿›è¡ŒåŠ é”æ“ä½œï¼Œè€Œä¸æ˜¯ segmentï¼Œè¿›ä¸€æ­¥å‡å°‘çº¿ç¨‹å†²çª</span>            <span class="hljs-keyword">synchronized</span> (f) &#123;                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) &#123;                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) &#123;                        binCount = <span class="hljs-number">1</span>;                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;                            K ek;                            <span class="hljs-comment">// å¦‚æœåœ¨é“¾è¡¨ä¸­æ‰¾åˆ°å€¼ä¸º key çš„èŠ‚ç‚¹ eï¼Œç›´æ¥è®¾ç½® e.val = value å³å¯ã€‚</span>                            <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;                                ((ek = e.key) == key ||                                 (ek != <span class="hljs-keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;                                oldVal = e.val;                                <span class="hljs-keyword">if</span> (!onlyIfAbsent)                                    e.val = value;                                <span class="hljs-keyword">break</span>;                            &#125;                            <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°å€¼ä¸º key çš„èŠ‚ç‚¹ï¼Œç›´æ¥æ–°å»º Node å¹¶åŠ å…¥é“¾è¡¨å³å¯ã€‚</span>                            Node&lt;K,V&gt; pred = e;                            <span class="hljs-keyword">if</span> ((e = e.next) == <span class="hljs-keyword">null</span>) &#123;                                pred.next = <span class="hljs-keyword">new</span> Node&lt;K,V&gt;(hash, key,                                                          value, <span class="hljs-keyword">null</span>);                                <span class="hljs-keyword">break</span>;                            &#125;                        &#125;                    &#125;                    <span class="hljs-comment">// å¦‚æœé¦–èŠ‚ç‚¹ä¸º TreeBin ç±»å‹ï¼Œè¯´æ˜ä¸ºçº¢é»‘æ ‘ç»“æ„ï¼Œæ‰§è¡Œ utTreeVal æ“ä½œã€‚</span>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) &#123;                        Node&lt;K,V&gt; p;                        binCount = <span class="hljs-number">2</span>;                        <span class="hljs-keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,                                                       value)) != <span class="hljs-keyword">null</span>) &#123;                            oldVal = p.val;                            <span class="hljs-keyword">if</span> (!onlyIfAbsent)                                p.val = value;                        &#125;                    &#125;                &#125;            &#125;            <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) &#123;                <span class="hljs-comment">// å¦‚æœèŠ‚ç‚¹æ•° &gt;ï¼8ï¼Œé‚£ä¹ˆè½¬æ¢é“¾è¡¨ç»“æ„ä¸ºçº¢é»‘æ ‘ç»“æ„ã€‚</span>                <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)                    treeifyBin(tab, i);                <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-keyword">null</span>)                    <span class="hljs-keyword">return</span> oldVal;                <span class="hljs-keyword">break</span>;            &#125;        &#125;    &#125;    <span class="hljs-comment">// è®¡æ•°å¢åŠ 1ï¼Œæœ‰å¯èƒ½è§¦å‘ transfer æ“ä½œ(æ‰©å®¹)ã€‚</span>    addCount(<span class="hljs-number">1L</span>, binCount);    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;&#125;</code></pre><h1 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a><code>CopyOnWriteArrayList</code></h1><p>æ¯ä¸ª <code>CopyOnWriteArrayList</code> å¯¹è±¡é‡Œæœ‰ä¸€ä¸ª <code>array</code> æ•°ç»„ç”¨æ¥å­˜æ”¾å…·ä½“å…ƒç´ ã€‚<code>ReentrantLock</code> ç‹¬å é”ç”¨æ¥ä¿è¯åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹ <code>array</code> è¿›è¡Œä¿®æ”¹ã€‚<br><img src="https://raw.githubusercontent.com/LikaiLee/likailee.github.io/img/20200724151232.png" srcset="/img/loading.gif" alt=""></p><h2 id="è¦ç‚¹"><a href="#è¦ç‚¹" class="headerlink" title="è¦ç‚¹"></a>è¦ç‚¹</h2><ul><li><p>å¥½å¤„ï¼š<strong>ä»»ä½•çš„è¯»æ“ä½œéƒ½ä¸ç”¨åŠ é”</strong>ï¼Œè€Œä¸”ä¿è¯è¯»å–åˆ°çš„æ˜¯è¯»é‚£ä¸€åˆ» <code>List</code> å®Œæ•´çš„å¿«ç…§æ•°æ®ã€‚ç”±äºè¯»æ“ä½œæ— æ³•æ„ŸçŸ¥æœ€æ–°æ­£åœ¨å˜åŒ–çš„æ•°æ®ï¼Œæ‰€ä»¥ <code>CopyOnWriteArrayList</code> æ˜¯<strong>å¼±ä¸€è‡´æ€§</strong>çš„ã€‚</p></li><li><p>å†™æ—¶å¤åˆ¶æŠ€æœ¯å› ä¸ºæ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦å®Œæ•´æ‹·è´ä¸€æ¬¡åº•å±‚æ•°ç»„ï¼Œæ‰€ä»¥æœ‰é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œä½†æ˜¯ç‰¹åˆ«é€‚ç”¨äº<strong>è¯»å¤šå†™å°‘</strong>çš„æ•°æ®è®¿é—®åœºæ™¯ã€‚</p></li></ul><h2 id="å¼±ä¸€è‡´æ€§é—®é¢˜"><a href="#å¼±ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="å¼±ä¸€è‡´æ€§é—®é¢˜"></a>å¼±ä¸€è‡´æ€§é—®é¢˜</h2><p>çº¿ç¨‹1åœ¨æ‰§è¡Œå®Œæ­¥éª¤ <code>A</code> åï¼Œæ‰§è¡Œæ­¥éª¤ <code>B</code> å‰ï¼Œçº¿ç¨‹2è¿›è¡Œäº† <code>remove</code> æ“ä½œã€‚<br>è™½ç„¶çº¿ç¨‹2å·²ç»åˆ é™¤äº† <code>index</code> å¤„çš„å…ƒç´ ï¼Œä½†ç”±äº <code>array</code>æŒ‡å‘çš„æ•°ç»„å¼•ç”¨è®¡æ•°ä¸º 1 è€Œä¸æ˜¯ 0ï¼Œä»ä¼šè¿”å› <code>index</code> å¤„çš„å…ƒç´ ã€‚</p><h2 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h2><p>å…ˆå°†åŸå®¹å™¨ copy ä¸€ä»½ï¼Œç„¶ååœ¨æ–°å‰¯æœ¬ä¸Šæ‰§è¡Œå†™æ“ä½œï¼Œä¹‹åå†åˆ‡æ¢å¼•ç”¨ã€‚</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;    <span class="hljs-comment">// 1.è·å–ç‹¬å é”</span>    <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock;    lock.lock();    <span class="hljs-keyword">try</span> &#123;        <span class="hljs-comment">// 2.è·å– array æ•°ç»„</span>        Object[] elements = getArray();        <span class="hljs-keyword">int</span> len = elements.length;        <span class="hljs-comment">// 3.å¤åˆ¶ array åˆ°æ–°æ•°ç»„</span>        Object[] newElements = Arrays.copyOf(elements, len + <span class="hljs-number">1</span>);        <span class="hljs-comment">// 4.æ·»åŠ å…ƒç´ åˆ°æ–°æ•°ç»„</span>        newElements[len] = e;        <span class="hljs-comment">// 5.ç”¨æ–°æ•°ç»„æ›¿æ¢åŸæ•°ç»„</span>        setArray(newElements);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125; <span class="hljs-keyword">finally</span> &#123;        <span class="hljs-comment">// 6.é‡Šæ”¾é”</span>        lock.unlock();    &#125;&#125;</code></pre><h2 id="åˆ é™¤å…ƒç´ "><a href="#åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ é™¤å…ƒç´ "></a>åˆ é™¤å…ƒç´ </h2><p>å°†é™¤è¦åˆ é™¤å…ƒç´ ä¹‹å¤–çš„å…¶ä»–å…ƒç´ æ‹·è´åˆ°æ–°å‰¯æœ¬ä¸­ï¼Œç„¶ååˆ‡æ¢å¼•ç”¨ï¼Œå°†åŸå®¹å™¨å¼•ç”¨æŒ‡å‘æ–°å‰¯æœ¬ã€‚åŒå±å†™æ“ä½œï¼Œéœ€è¦åŠ é”ã€‚</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">remove</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123;    <span class="hljs-comment">// è·å–ç‹¬å é”</span>    <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock;    lock.lock();    <span class="hljs-keyword">try</span> &#123;        Object[] elements = getArray();        <span class="hljs-keyword">int</span> len = elements.length;        E oldValue = get(elements, index);        <span class="hljs-comment">// éœ€è¦ç§»åŠ¨çš„å…ƒç´ ä¸ªæ•°</span>        <span class="hljs-keyword">int</span> numMoved = len - index - <span class="hljs-number">1</span>;        <span class="hljs-comment">// è‹¥åˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ </span>        <span class="hljs-keyword">if</span> (numMoved == <span class="hljs-number">0</span>)           <span class="hljs-comment">// æ‹·è´å‰len-1ä¸ªæ•°æ®åˆ°æ–°å‰¯æœ¬ä¸Šï¼Œå†åˆ‡æ¢å¼•ç”¨</span>           setArray(Arrays.copyOf(elements, len - <span class="hljs-number">1</span>));        <span class="hljs-keyword">else</span> &#123;            Object[] newElements = <span class="hljs-keyword">new</span> Object[len - <span class="hljs-number">1</span>];            <span class="hljs-comment">// åˆ†ä¸¤å—å¤åˆ¶åˆ°æ–°æ•°ç»„</span>            System.arraycopy(elements, <span class="hljs-number">0</span>, newElements, <span class="hljs-number">0</span>, index);            System.arraycopy(elements, index + <span class="hljs-number">1</span>, newElements, index,                             numMoved);            <span class="hljs-comment">// è®¾ç½®æ–°æ•°ç»„</span>            setArray(newElements);        &#125;        <span class="hljs-keyword">return</span> oldValue;    &#125; <span class="hljs-keyword">finally</span> &#123;        <span class="hljs-comment">// é‡Šæ”¾é”</span>        lock.unlock();    &#125;&#125;</code></pre><h2 id="è¯»æ“ä½œ"><a href="#è¯»æ“ä½œ" class="headerlink" title="è¯»æ“ä½œ"></a>è¯»æ“ä½œ</h2><p><code>E get(int index)</code><br>è¯»æ“ä½œæ˜¯ä¸ç”¨åŠ é”çš„ï¼Œæ€§èƒ½å¾ˆé«˜ã€‚</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123;    <span class="hljs-keyword">return</span> get(getArray(), index);&#125;<span class="hljs-comment">// A.è·å– array æ•°ç»„</span><span class="hljs-keyword">final</span> Object[] getArray() &#123;    <span class="hljs-keyword">return</span> array;&#125;<span class="hljs-comment">// B.é€šè¿‡ä¸‹æ ‡è®¿é—®æŒ‡å®šä½ç½®çš„æ•°ç»„å…ƒç´ </span><span class="hljs-function"><span class="hljs-keyword">private</span> E <span class="hljs-title">get</span><span class="hljs-params">(Object[] a, <span class="hljs-keyword">int</span> index)</span> </span>&#123;    <span class="hljs-keyword">return</span> (E) a[index];&#125;</code></pre><h2 id="ä¿®æ”¹æŒ‡å®šå…ƒç´ "><a href="#ä¿®æ”¹æŒ‡å®šå…ƒç´ " class="headerlink" title="ä¿®æ”¹æŒ‡å®šå…ƒç´ "></a>ä¿®æ”¹æŒ‡å®šå…ƒç´ </h2><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index, E element)</span> </span>&#123;    <span class="hljs-comment">// è·å–ç‹¬å é”</span>    <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock;    lock.lock();    <span class="hljs-keyword">try</span> &#123;        <span class="hljs-comment">// è·å– array æ•°ç»„</span>        Object[] elements = getArray();        <span class="hljs-comment">// æ‰¾åˆ°åŸä½ç½®ä¸Šçš„å€¼</span>        E oldValue = get(elements, index);        <span class="hljs-keyword">if</span> (oldValue != element) &#123;            <span class="hljs-keyword">int</span> len = elements.length;            <span class="hljs-comment">// å¤åˆ¶ array åˆ°æ–°æ•°ç»„</span>            Object[] newElements = Arrays.copyOf(elements, len);            <span class="hljs-comment">// è®¾ç½® index ä½ç½®çš„å…ƒç´ </span>            newElements[index] = element;            <span class="hljs-comment">// ç”¨æ–°æ•°ç»„æ›¿æ¢æ—§æ•°ç»„</span>            setArray(newElements);        &#125; <span class="hljs-keyword">else</span> &#123;            <span class="hljs-comment">// Not quite a no-op; ensures volatile write semantics</span>            setArray(elements);        &#125;        <span class="hljs-keyword">return</span> oldValue;    &#125; <span class="hljs-keyword">finally</span> &#123;        <span class="hljs-comment">// é‡Šæ”¾é”</span>        lock.unlock();    &#125;&#125;</code></pre><h1 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a><code>BlockingQueue</code></h1><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BlockingQueue</span>&lt;<span class="hljs-title">E</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">Queue</span>&lt;<span class="hljs-title">E</span>&gt; </span>&#123;&#125;</code></pre><p>åœ¨ <code>BlockingQueue</code> ä¸­ï¼Œå¦‚æœè·å–é˜Ÿåˆ—å…ƒç´ ä½†æ˜¯é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¼šé˜»å¡ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ å†è¿”å›ï¼›å¦‚æœæ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œé‚£ä¹ˆç­‰åˆ°é˜Ÿåˆ—å¯ä»¥æ”¾å…¥æ–°å…ƒç´ æ—¶å†æ”¾å…¥ã€‚</p><p><code>BlockingQueue</code> å¯¹æ’å…¥æ“ä½œã€ç§»é™¤æ“ä½œã€è·å–å…ƒç´ æ“ä½œæä¾›äº†å››ç§ä¸åŒçš„æ–¹æ³•ç”¨äºä¸åŒçš„åœºæ™¯ä¸­ä½¿ç”¨ï¼š</p><p>æŠ›å‡ºå¼‚å¸¸ï¼›</p><ul><li>è¿”å›ç‰¹æ®Šå€¼ï¼ˆ<code>null</code> æˆ– <code>true</code>/<code>false</code>ï¼Œå–å†³äºå…·ä½“çš„æ“ä½œï¼‰ï¼›</li><li>é˜»å¡ç­‰å¾…æ­¤æ“ä½œï¼Œç›´åˆ°è¿™ä¸ªæ“ä½œæˆåŠŸï¼›</li><li>é˜»å¡ç­‰å¾…æ­¤æ“ä½œï¼Œç›´åˆ°æˆåŠŸæˆ–è€…è¶…æ—¶æŒ‡å®šæ—¶é—´ã€‚<br>æ€»ç»“å¦‚ä¸‹ï¼š</li></ul><table><thead><tr><th align="center">Operation</th><th align="center">Throws exception</th><th align="center">Special value</th><th align="center">Blocks</th><th align="center">Times out</th></tr></thead><tbody><tr><td align="center">Insert</td><td align="center">add(e)</td><td align="center">offer(e)</td><td align="center">put(e)</td><td align="center">offer(e, time, unit)</td></tr><tr><td align="center">Remove</td><td align="center">remove()</td><td align="center">poll()</td><td align="center">take()</td><td align="center">poll(time, unit)</td></tr><tr><td align="center">Examine</td><td align="center">element()</td><td align="center">peek()</td><td align="center">not applicable</td><td align="center">not applicable</td></tr></tbody></table><p><code>BlockingQueue</code> çš„å„ä¸ªå®ç°ç±»éƒ½éµå¾ªäº†è¿™äº›è§„åˆ™ã€‚</p><p><code>BlockingQueue</code> ä¸æ¥å— <code>null</code> å€¼å…ƒç´ ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>å¹¶å‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¹¶å‘</tag>
      
      <tag>å®¹å™¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¹¶å‘-åŸå­ç±»</title>
    <link href="/2020/07/21/concurrent-atomic/"/>
    <url>/2020/07/21/concurrent-atomic/</url>
    
    <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><h2 id="ä¸ºä½•éœ€è¦åŸå­å˜é‡ç±»"><a href="#ä¸ºä½•éœ€è¦åŸå­å˜é‡ç±»" class="headerlink" title="ä¸ºä½•éœ€è¦åŸå­å˜é‡ç±»"></a>ä¸ºä½•éœ€è¦åŸå­å˜é‡ç±»</h2><p>ä¿è¯çº¿ç¨‹å®‰å…¨æ˜¯ <code>Java</code> å¹¶å‘ç¼–ç¨‹å¿…é¡»è¦è§£å†³çš„é‡è¦é—®é¢˜ã€‚<code>Java</code> ä»åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§è¿™ä¸‰å¤§ç‰¹æ€§å…¥æ‰‹ï¼Œç¡®ä¿å¤šçº¿ç¨‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p><ul><li><p>ç¡®ä¿çº¿ç¨‹å®‰å…¨æœ€å¸¸è§çš„åšæ³•æ˜¯åˆ©ç”¨é”æœºåˆ¶ï¼ˆ<code>Lock</code>ã€<code>sychronized</code>ï¼‰æ¥å¯¹å…±äº«æ•°æ®åšäº’æ–¥åŒæ­¥ï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡ŒæŸä¸ªæ–¹æ³•æˆ–è€…æŸä¸ªä»£ç å—ï¼Œé‚£ä¹ˆæ“ä½œå¿…ç„¶æ˜¯åŸå­æ€§çš„ï¼Œçº¿ç¨‹å®‰å…¨çš„ã€‚äº’æ–¥åŒæ­¥æœ€ä¸»è¦çš„é—®é¢˜æ˜¯çº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚</p></li><li><p><code>volatile</code> æ˜¯è½»é‡çº§çš„é”ï¼ˆè‡ªç„¶æ¯”æ™®é€šé”æ€§èƒ½è¦å¥½ï¼‰ï¼Œå®ƒä¿è¯äº†å…±äº«å˜é‡åœ¨å¤šçº¿ç¨‹ä¸­çš„å¯è§æ€§ï¼Œä½†æ— æ³•ä¿è¯åŸå­æ€§ã€‚æ‰€ä»¥ï¼Œå®ƒåªèƒ½åœ¨ä¸€äº›ç‰¹å®šåœºæ™¯ä¸‹ä½¿ç”¨ã€‚</p></li><li><p>ä¸ºäº†å…¼é¡¾åŸå­æ€§ä»¥åŠé”å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œ<code>Java</code> å¼•å…¥äº† <code>CAS</code> ï¼ˆä¸»è¦ä½“ç°åœ¨ Unsafe ç±»ï¼‰æ¥å®ç°éé˜»å¡åŒæ­¥ï¼ˆä¹Ÿå«ä¹è§‚é”ï¼‰ã€‚å¹¶åŸºäº <code>CAS</code> ï¼Œæä¾›äº†ä¸€å¥—åŸå­å·¥å…·ç±»ã€‚</p></li></ul><h2 id="åŸå­å˜é‡ç±»çš„ä½œç”¨"><a href="#åŸå­å˜é‡ç±»çš„ä½œç”¨" class="headerlink" title="åŸå­å˜é‡ç±»çš„ä½œç”¨"></a>åŸå­å˜é‡ç±»çš„ä½œç”¨</h2><p>åŸå­å˜é‡ç±» <strong>æ¯”é”çš„ç²’åº¦æ›´ç»†ï¼Œæ›´è½»é‡çº§</strong>ï¼Œå¹¶ä¸”å¯¹äºåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå®ç°é«˜æ€§èƒ½çš„å¹¶å‘ä»£ç æ¥è¯´æ˜¯éå¸¸å…³é”®çš„ã€‚åŸå­å˜é‡å°†å‘ç”Ÿç«äº‰çš„èŒƒå›´ç¼©å°åˆ°å•ä¸ªå˜é‡ä¸Šã€‚</p><p>åŸå­å˜é‡ç±»ç›¸å½“äºä¸€ç§æ³›åŒ–çš„ <code>volatile</code> å˜é‡ï¼Œèƒ½å¤Ÿæ”¯æŒ<strong>åŸå­çš„ã€æœ‰æ¡ä»¶çš„è¯»/æ”¹/å†™</strong>æ“ä½œã€‚</p><p>åŸå­ç±»åœ¨å†…éƒ¨ä½¿ç”¨ <code>CAS</code> æŒ‡ä»¤ï¼ˆåŸºäºç¡¬ä»¶çš„æ”¯æŒï¼‰æ¥å®ç°åŒæ­¥ã€‚è¿™äº›æŒ‡ä»¤é€šå¸¸æ¯”é”æ›´å¿«ã€‚</p><p>åŸå­å˜é‡ç±»å¯ä»¥åˆ†ä¸º <code>4</code> ç»„ï¼š</p><ul><li>åŸºæœ¬ç±»å‹<ul><li><code>AtomicBoolean</code> - å¸ƒå°”ç±»å‹åŸå­ç±»</li><li><code>AtomicInteger</code> - æ•´å‹åŸå­ç±»</li><li><code>AtomicLong</code> - é•¿æ•´å‹åŸå­ç±»</li></ul></li><li>å¼•ç”¨ç±»å‹<ul><li><code>AtomicReference</code> - å¼•ç”¨ç±»å‹åŸå­ç±»</li><li><code>AtomicMarkableReference</code> - å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li><li><code>AtomicStampedReference</code> - å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li></ul></li><li>æ•°ç»„ç±»å‹<ul><li><code>AtomicIntegerArray</code> - æ•´å½¢æ•°ç»„åŸå­ç±»</li><li><code>AtomicLongArray</code> - é•¿æ•´å‹æ•°ç»„åŸå­ç±»</li><li><code>AtomicReferenceArray</code> - å¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li></ul></li><li>å±æ€§æ›´æ–°å™¨ç±»å‹<ul><li><code>AtomicIntegerFieldUpdater</code> - æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</li><li><code>AtomicLongFieldUpdater</code> - é•¿æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</li><li><code>AtomicReferenceFieldUpdater</code> - åŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µã€‚</li></ul></li></ul><h1 id="åŸºæœ¬ç±»å‹"><a href="#åŸºæœ¬ç±»å‹" class="headerlink" title="åŸºæœ¬ç±»å‹"></a>åŸºæœ¬ç±»å‹</h1><p>è¿™ä¸€ç±»å‹çš„åŸå­ç±»æ˜¯é’ˆå¯¹ <code>Java</code> åŸºæœ¬ç±»å‹è¿›è¡Œæ“ä½œã€‚</p><ul><li><p><code>AtomicBoolean</code> - å¸ƒå°”ç±»å‹åŸå­ç±»</p></li><li><p><code>AtomicInteger</code> - æ•´å‹åŸå­ç±»</p></li><li><p><code>AtomicLong</code> - é•¿æ•´å‹åŸå­ç±»</p></li></ul><p>ä»¥ä¸Šç±»éƒ½æ”¯æŒ <code>CAS</code>ï¼Œæ­¤å¤–ï¼Œ<code>AtomicInteger</code>ã€<code>AtomicLong</code> è¿˜æ”¯æŒç®—æœ¯è¿ç®—ã€‚</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-comment">// è·å–å½“å‰å€¼</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAndSet</span><span class="hljs-params">(<span class="hljs-keyword">int</span> newValue)</span> <span class="hljs-comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è®¾ç½®æ–°å€¼</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAndIncrement</span><span class="hljs-params">()</span><span class="hljs-comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è‡ªå¢</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAndDecrement</span><span class="hljs-params">()</span> <span class="hljs-comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è‡ªå‡</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAndAdd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> delta)</span> <span class="hljs-comment">// è·å–å½“å‰å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸå€¼</span></span><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">compareAndSet</span><span class="hljs-params">(<span class="hljs-keyword">int</span> expect, <span class="hljs-keyword">int</span> update)</span> <span class="hljs-comment">// å¦‚æœè¾“å…¥å€¼ï¼ˆupdateï¼‰ç­‰äºé¢„æœŸå€¼ï¼Œå°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼</span></span><span class="hljs-function"><span class="hljs-comment">// æœ€ç»ˆè®¾ç½®ä¸º newValueï¼Œä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lazySet</span><span class="hljs-params">(<span class="hljs-keyword">int</span> newValue)</span></span></code></pre><h1 id="å¼•ç”¨ç±»å‹"><a href="#å¼•ç”¨ç±»å‹" class="headerlink" title="å¼•ç”¨ç±»å‹"></a>å¼•ç”¨ç±»å‹</h1><ul><li><p><code>AtomicReference</code> - å¼•ç”¨ç±»å‹åŸå­ç±»</p></li><li><p><code>AtomicMarkableReference</code> - å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹åŸå­ç±»</p></li><li><p><code>AtomicStampedReference</code> - å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹åŸå­ç±»</p></li></ul><blockquote><p><code>AtomicStampedReference</code> ç±»åœ¨å¼•ç”¨ç±»å‹åŸå­ç±»ä¸­ï¼Œå½»åº•åœ°è§£å†³äº† <code>ABA</code> é—®é¢˜ï¼Œå…¶å®ƒçš„ <code>CAS</code> èƒ½åŠ›ä¸å¦å¤–ä¸¤ä¸ªç±»ç›¸è¿‘ï¼Œæ‰€ä»¥æœ€å…·ä»£è¡¨æ€§ã€‚å› æ­¤ï¼Œæœ¬èŠ‚åªé’ˆå¯¹ <code>AtomicStampedReference</code> è¿›è¡Œè¯´æ˜ã€‚</p></blockquote><h2 id="AtomicReference"><a href="#AtomicReference" class="headerlink" title="AtomicReference"></a>AtomicReference</h2><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * åŸºäº AtomicReference å®ç°è‡ªæ—‹é”</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> likailee.llk</span><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> : AtomicRefTest.java 2020/07/21 Tue 4:00 PM likai</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicRefTest</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> ticket = <span class="hljs-number">10</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        SpinLock lock = <span class="hljs-keyword">new</span> SpinLock();        ExecutorService executorService = Executors.newFixedThreadPool(<span class="hljs-number">3</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;            executorService.execute(<span class="hljs-keyword">new</span> MyThread(lock));        &#125;        executorService.shutdown();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * SpinLock</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpinLock</span> </span>&#123;        <span class="hljs-keyword">private</span> AtomicReference&lt;Thread&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;            Thread current = Thread.currentThread();            <span class="hljs-comment">// è‡ªæ—‹ï¼Œä¸ºå½“å‰çº¿ç¨‹åŠ é”</span>            <span class="hljs-keyword">while</span> (!atomicReference.compareAndSet(<span class="hljs-keyword">null</span>, current)) &#123;            &#125;        &#125;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;            Thread current = Thread.currentThread();            <span class="hljs-comment">// åªæœ‰å½“å‰çº¿ç¨‹æ‰é‡Šæ”¾é”</span>            atomicReference.compareAndSet(current, <span class="hljs-keyword">null</span>);        &#125;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * sell ticket by spin lock</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;        <span class="hljs-keyword">private</span> SpinLock lock;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyThread</span><span class="hljs-params">(SpinLock lock)</span> </span>&#123;            <span class="hljs-keyword">this</span>.lock = lock;        &#125;        <span class="hljs-meta">@Override</span>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;            <span class="hljs-keyword">while</span> (ticket &gt; <span class="hljs-number">0</span>) &#123;                lock.lock();                <span class="hljs-keyword">if</span> (ticket &gt; <span class="hljs-number">0</span>) &#123;                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" sell ticket "</span> + ticket);                    ticket--;                &#125;                lock.unlock();            &#125;        &#125;            &#125;&#125;</code></pre><h2 id="AtomicMarkableReference"><a href="#AtomicMarkableReference" class="headerlink" title="AtomicMarkableReference"></a>AtomicMarkableReference</h2><p>åŸå­ç±»çš„å®ç°åŸºäº <code>CAS</code> æœºåˆ¶ï¼Œè€Œ <code>CAS</code> å­˜åœ¨ <code>ABA</code> é—®é¢˜ã€‚æ­£æ˜¯ä¸ºäº†è§£å†³ <code>ABA</code> é—®é¢˜ï¼Œæ‰æœ‰äº† <code>AtomicMarkableReference</code> å’Œ <code>AtomicStampedReference</code>ã€‚</p><p><code>AtomicMarkableReference</code> ä½¿ç”¨ä¸€ä¸ªå¸ƒå°”å€¼ä½œä¸ºæ ‡è®°ï¼Œä¿®æ”¹æ—¶åœ¨ <code>true</code> / <code>false</code> ä¹‹é—´åˆ‡æ¢ã€‚è¿™ç§ç­–ç•¥ä¸èƒ½æ ¹æœ¬ä¸Šè§£å†³ <code>ABA</code> é—®é¢˜ï¼Œä½†æ˜¯å¯ä»¥é™ä½ <code>ABA</code> å‘ç”Ÿçš„å‡ ç‡ã€‚å¸¸ç”¨äºç¼“å­˜æˆ–è€…çŠ¶æ€æè¿°è¿™æ ·çš„åœºæ™¯ã€‚</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * AtomicMarkableReference ä½¿ç”¨</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> likailee.llk</span><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> : AtomicMarkableRefTest.java 2020/07/21 Tue 4:32 PM likai</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicMarkableRefTest</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String INIT_TEXT = <span class="hljs-string">"abc"</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        <span class="hljs-keyword">final</span> AtomicMarkableReference&lt;String&gt; amr = <span class="hljs-keyword">new</span> AtomicMarkableReference&lt;&gt;(INIT_TEXT, <span class="hljs-keyword">false</span>);        ExecutorService executorService = Executors.newFixedThreadPool(<span class="hljs-number">3</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;            executorService.submit(() -&gt; &#123;                <span class="hljs-keyword">try</span> &#123;                    Thread.sleep(Math.abs((<span class="hljs-keyword">int</span>) Math.random() * <span class="hljs-number">100</span>));                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                    e.printStackTrace();                &#125;                String name = Thread.currentThread().getName(); Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">// è‹¥å˜é‡ä¸º INIT &amp;&amp; å·²è¢«æ ‡è®°ï¼Œåˆ™ä¿®æ”¹</span> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (amr.compareAndSet(INIT_TEXT, name, amr.isMarked(), !amr.isMarked())) &#123; Â  Â  Â  Â  Â  Â  Â  Â String name = Thread.currentThread().getName();                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" ä¿®æ”¹äº†å¯¹è±¡"</span>);                    System.out.println(<span class="hljs-string">"æ–°çš„å¯¹è±¡ä¸ºï¼š"</span> + amr.getReference());                &#125;            &#125;);        &#125;        executorService.shutdown();        executorService.awaitTermination(<span class="hljs-number">3</span>, TimeUnit.SECONDS);    &#125;&#125;</code></pre><h2 id="AtomicStampedReference"><a href="#AtomicStampedReference" class="headerlink" title="AtomicStampedReference"></a>AtomicStampedReference</h2><p><code>AtomicStampedReference</code> ä½¿ç”¨ä¸€ä¸ªæ•´å‹å€¼åšä¸ºç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ›´æ–°å‰å…ˆæ¯”è¾ƒç‰ˆæœ¬å·ï¼Œå¦‚æœä¸€è‡´ï¼Œæ‰è¿›è¡Œä¿®æ”¹ã€‚é€šè¿‡è¿™ç§ç­–ç•¥ï¼Œå¯ä»¥æ ¹æœ¬ä¸Šè§£å†³ <code>ABA</code> é—®é¢˜ã€‚</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * AtomicStampedReference ä½¿ç”¨</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> likailee.llk</span><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> : AtomicStampedRefTest.java 2020/07/21 Tue 7:02 PM likai</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicStampedRefTest</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String INIT_REF = <span class="hljs-string">"pool-1-thread-3"</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> AtomicStampedReference&lt;String&gt; asr = <span class="hljs-keyword">new</span> AtomicStampedReference&lt;&gt;(INIT_REF, <span class="hljs-number">0</span>);    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        System.out.println(<span class="hljs-string">"åˆå§‹å¯¹è±¡ä¸º: "</span> + asr.getReference());        ExecutorService executorService = Executors.newFixedThreadPool(<span class="hljs-number">3</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;            executorService.submit(() -&gt; &#123;                <span class="hljs-keyword">try</span> &#123;                    Thread.sleep(Math.abs((<span class="hljs-keyword">int</span>) Math.random() * <span class="hljs-number">100</span>));                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                    e.printStackTrace();                &#125;                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> stamp = asr.getStamp();                String name = Thread.currentThread().getName(); Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">// è‹¥å˜é‡ä¸º INIT &amp;&amp; ç‰ˆæœ¬å·ä¸º stampï¼Œåˆ™ä¿®æ”¹</span>                <span class="hljs-keyword">if</span> (asr.compareAndSet(INIT_REF, name, stamp, stamp + <span class="hljs-number">1</span>)) &#123;                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" ä¿®æ”¹äº†å¯¹è±¡"</span>);                    System.out.println(<span class="hljs-string">"æ–°çš„å¯¹è±¡ä¸ºï¼š"</span> + asr.getReference());                &#125;            &#125;);        &#125;        executorService.shutdown();        executorService.awaitTermination(<span class="hljs-number">3</span>, TimeUnit.SECONDS);    &#125;&#125;</code></pre><h1 id="æ•°ç»„ç±»å‹"><a href="#æ•°ç»„ç±»å‹" class="headerlink" title="æ•°ç»„ç±»å‹"></a>æ•°ç»„ç±»å‹</h1><ul><li><p><code>AtomicIntegerArray</code> - æ•´å½¢æ•°ç»„åŸå­ç±»</p></li><li><p><code>AtomicLongArray</code> - é•¿æ•´å‹æ•°ç»„åŸå­ç±»</p></li><li><p><code>AtomicReferenceArray</code> - å¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</p></li></ul><p>æ•°ç»„ç±»å‹çš„åŸå­ç±»ä¸º <strong>æ•°ç»„å…ƒç´ </strong> æä¾›äº† <code>volatile</code> ç±»å‹çš„è®¿é—®è¯­ä¹‰ï¼Œè¿™æ˜¯æ™®é€šæ•°ç»„æ‰€ä¸å…·å¤‡çš„ç‰¹æ€§ â€”â€” <code>volatile</code> ç±»å‹çš„æ•°ç»„ä»…åœ¨<strong>æ•°ç»„å¼•ç”¨</strong>ä¸Šå…·æœ‰ <code>volatile</code> è¯­ä¹‰ã€‚</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * AtomicIntegerArray ä½¿ç”¨</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> likailee.llk</span><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> : AtomicIntegerArrayTest.java 2020/07/21 Tue 7:17 PM likai</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicIntegerArrayTest</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AtomicIntegerArray atomicIntegerArray = <span class="hljs-keyword">new</span> AtomicIntegerArray(<span class="hljs-number">10</span>);    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;        System.out.println(<span class="hljs-string">"Init Values: "</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; atomicIntegerArray.length(); i++) &#123;            atomicIntegerArray.set(i, i);            System.out.print(atomicIntegerArray.get(i) + <span class="hljs-string">" "</span>);        &#125;        System.out.println();        Thread t1 = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Increasement());        Thread t2 = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Compare());        t1.start();        t2.start();        t1.join();        t2.join();        System.out.println(<span class="hljs-string">"Final Values: "</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; atomicIntegerArray.length(); i++) &#123;            System.out.print(atomicIntegerArray.get(i) + <span class="hljs-string">" "</span>);        &#125;        System.out.println();    &#125;    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Increasement</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;        <span class="hljs-meta">@Override</span>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123; Â  Â  Â   <span class="hljs-comment">// å¯¹æ•°ç»„çš„æ¯ä¸ªå…ƒç´ è‡ªå¢ 1</span> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; atomicIntegerArray.length(); i++) &#123;                <span class="hljs-keyword">int</span> value = atomicIntegerArray.incrementAndGet(i);                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">", index = "</span> + i + <span class="hljs-string">", value = "</span> + value);            &#125;        &#125;    &#125;    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Compare</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;        <span class="hljs-meta">@Override</span>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123; Â  Â  Â   <span class="hljs-comment">// æ‰¾åˆ°æ•°ç»„å€¼ä¸º 2 çš„å…ƒç´ ï¼Œä¿®æ”¹ä¸º 3</span> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; atomicIntegerArray.length(); i++) &#123;                <span class="hljs-keyword">boolean</span> swapped = atomicIntegerArray.compareAndSet(i, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);                <span class="hljs-keyword">if</span> (swapped) &#123;                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" swapped, index = "</span> + i + <span class="hljs-string">", value = 3"</span>);                &#125;            &#125;        &#125;    &#125;&#125;</code></pre><h1 id="å±æ€§æ›´æ–°å™¨ç±»å‹"><a href="#å±æ€§æ›´æ–°å™¨ç±»å‹" class="headerlink" title="å±æ€§æ›´æ–°å™¨ç±»å‹"></a>å±æ€§æ›´æ–°å™¨ç±»å‹</h1><p>æ›´æ–°å™¨ç±»æ”¯æŒåŸºäº<strong>åå°„</strong>æœºåˆ¶çš„æ›´æ–°å­—æ®µå€¼çš„åŸå­æ“ä½œã€‚</p><ul><li><p><code>AtomicIntegerFieldUpdater</code> - æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</p></li><li><p><code>AtomicLongFieldUpdater</code> - é•¿æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</p></li><li><p><code>AtomicReferenceFieldUpdater</code> - åŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µã€‚</p></li></ul><p>è¿™äº›ç±»çš„ä½¿ç”¨æœ‰ä¸€å®šé™åˆ¶ï¼š</p><ul><li>å› ä¸ºå¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³• <code>newUpdater()</code> åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚</li><li>å­—æ®µå¿…é¡»æ˜¯ <code>volatile</code> ç±»å‹çš„ï¼›</li><li>ä¸èƒ½ä½œç”¨äºé™æ€å˜é‡ï¼ˆ<code>static</code>ï¼‰ï¼›</li><li>ä¸èƒ½ä½œç”¨äºå¸¸é‡ï¼ˆ<code>final</code>ï¼‰ï¼›</li></ul><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * AtomicReferenceFieldUpdater ä½¿ç”¨</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> likailee.llk</span><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> : AtomicFieldUpdaterTest.java 2020/07/21 Tue 7:33 PM likai</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicFieldUpdaterTest</span> </span>&#123;    <span class="hljs-keyword">static</span> User user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">"begin"</span>);    <span class="hljs-keyword">static</span> AtomicReferenceFieldUpdater&lt;User, String&gt; updater =            AtomicReferenceFieldUpdater.newUpdater(User.class, String.class, "name");    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        ExecutorService executorService = Executors.newFixedThreadPool(<span class="hljs-number">3</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;            executorService.submit(() -&gt; &#123; Â  Â  Â  Â  Â   <span class="hljs-comment">// è‹¥ name çš„å€¼ä¸º â€beginâ€œï¼Œåˆ™ä¿®æ”¹ä¸º â€œendâ€œ</span> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (updater.compareAndSet(user, <span class="hljs-string">"begin"</span>, <span class="hljs-string">"end"</span>)) &#123;                    <span class="hljs-keyword">try</span> &#123;                        TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                        e.printStackTrace();                    &#125;                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" å·²ä¿®æ”¹ name = "</span> + user.getName());                &#125; <span class="hljs-keyword">else</span> &#123;                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"å·²è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹"</span>);                &#125;            &#125;);        &#125;        executorService.shutdown();    &#125;    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;        <span class="hljs-keyword">volatile</span> String name;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(String name)</span> </span>&#123;            <span class="hljs-keyword">this</span>.name = name;        &#125;        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;            <span class="hljs-keyword">return</span> name;        &#125;        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;            <span class="hljs-keyword">this</span>.name = name;        &#125;    &#125;&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>å¹¶å‘</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å¹¶å‘-é”åŸç†</title>
    <link href="/2020/07/17/concurrent-lock/"/>
    <url>/2020/07/17/concurrent-lock/</url>
    
    <content type="html"><![CDATA[<h1 id="å¹¶å‘é”"><a href="#å¹¶å‘é”" class="headerlink" title="å¹¶å‘é”"></a>å¹¶å‘é”</h1><h2 id="ä¹è§‚é”å’Œæ‚²è§‚é”"><a href="#ä¹è§‚é”å’Œæ‚²è§‚é”" class="headerlink" title="ä¹è§‚é”å’Œæ‚²è§‚é”"></a>ä¹è§‚é”å’Œæ‚²è§‚é”</h2><p>ä¹è§‚é”å’Œæ‚²è§‚é”æ˜¯ä¸¤ç§æ€æƒ³ï¼Œç”¨äºè§£å†³å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ç«äº‰é—®é¢˜ã€‚</p><h3 id="ä¹è§‚é”"><a href="#ä¹è§‚é”" class="headerlink" title="ä¹è§‚é”"></a>ä¹è§‚é”</h3><p>ä¹è§‚é”åœ¨æ“ä½œæ•°æ®æ—¶éå¸¸ä¹è§‚ï¼Œè®¤ä¸ºåˆ«äººä¸ä¼šåŒæ—¶ä¿®æ”¹æ•°æ®ã€‚å› æ­¤<strong>ä¹è§‚é”ä¸ä¼šä¸Šé”</strong>ï¼Œåªæ˜¯åœ¨æ‰§è¡Œæ›´æ–°çš„æ—¶å€™åˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæ˜¯å¦ä¿®æ”¹äº†æ•°æ®ï¼šå¦‚æœåˆ«äººä¿®æ”¹äº†æ•°æ®åˆ™æ”¾å¼ƒæ“ä½œï¼Œå¦åˆ™æ‰§è¡Œæ“ä½œã€‚</p><h4 id="å®ç°æ–¹å¼"><a href="#å®ç°æ–¹å¼" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h4><ol><li><code>CAS</code> æœºåˆ¶</li></ol><p><code>CAS</code> æ“ä½œåŒ…æ‹¬äº† 3 ä¸ªæ“ä½œæ•°ï¼š<br>    (1) éœ€è¦è¯»å†™çš„å†…å­˜ä½ç½®(<code>V</code>)<br>    (2) è¿›è¡Œæ¯”è¾ƒçš„é¢„æœŸå€¼(<code>A</code>)<br>    (3) æ‹Ÿå†™å…¥çš„æ–°å€¼(<code>B</code>) </p><p><code>CAS</code> æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼šå¦‚æœå†…å­˜ä½ç½® <code>V</code> çš„å€¼ç­‰äºé¢„æœŸçš„ <code>A</code> å€¼ï¼Œåˆ™å°†è¯¥ä½ç½®æ›´æ–°ä¸ºæ–°å€¼ <code>B</code>ï¼Œå¦åˆ™ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚è®¸å¤š <code>CAS</code> çš„æ“ä½œæ˜¯è‡ªæ—‹çš„ï¼šå¦‚æœæ“ä½œä¸æˆåŠŸï¼Œä¼šä¸€ç›´é‡è¯•ï¼Œç›´åˆ°æ“ä½œæˆåŠŸä¸ºæ­¢ã€‚</p><blockquote><p><code>CAS</code> æ˜¯ç”± <code>CPU</code> æ”¯æŒçš„åŸå­æ“ä½œï¼Œå…¶åŸå­æ€§æ˜¯åœ¨ç¡¬ä»¶å±‚é¢è¿›è¡Œä¿è¯çš„ã€‚</p></blockquote><ol start="2"><li>ç‰ˆæœ¬å·æœºåˆ¶<br>ç‰ˆæœ¬å·æœºåˆ¶çš„åŸºæœ¬æ€è·¯æ˜¯åœ¨æ•°æ®ä¸­å¢åŠ ä¸€ä¸ªå­—æ®µ <code>version</code>ï¼Œè¡¨ç¤ºè¯¥æ•°æ®çš„ç‰ˆæœ¬å·ï¼Œæ¯å½“æ•°æ®è¢«ä¿®æ”¹ï¼Œç‰ˆæœ¬å· <code>+1</code>ã€‚</li></ol><ul><li>å½“æŸä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®æ—¶ï¼Œå°†è¯¥æ•°æ®çš„ç‰ˆæœ¬å·ä¸€èµ·æŸ¥å‡ºæ¥ï¼›</li><li>å½“è¯¥çº¿ç¨‹æ›´æ–°æ•°æ®æ—¶ï¼Œåˆ¤æ–­å½“å‰ç‰ˆæœ¬å·ä¸ä¹‹å‰è¯»å–çš„ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´æ‰è¿›è¡Œæ“ä½œã€‚</li></ul><h3 id="æ‚²è§‚é”"><a href="#æ‚²è§‚é”" class="headerlink" title="æ‚²è§‚é”"></a>æ‚²è§‚é”</h3><p>æ‚²è§‚é”åœ¨æ“ä½œæ•°æ®æ—¶æ¯”è¾ƒæ‚²è§‚ï¼Œè®¤ä¸ºåˆ«äººä¼šåŒæ—¶ä¿®æ”¹æ•°æ®ã€‚å› æ­¤æ“ä½œæ•°æ®æ—¶ç›´æ¥æŠŠæ•°æ®é”ä½ï¼Œç›´åˆ°æ“ä½œå®Œæˆåæ‰ä¼šé‡Šæ”¾é”ï¼›ä¸Šé”æœŸé—´å…¶ä»–äººä¸èƒ½ä¿®æ”¹æ•°æ®ã€‚</p><h4 id="å®ç°æ–¹å¼-1"><a href="#å®ç°æ–¹å¼-1" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h4><p>æ‚²è§‚é”çš„å®ç°æ–¹å¼æ˜¯<strong>åŠ é”</strong>ï¼ŒåŠ é”æ—¢å¯ä»¥æ˜¯å¯¹<strong>ä»£ç å—åŠ é”</strong>ï¼ˆå¦‚ <code>Java</code>çš„ <code>synchronized</code> å…³é”®å­—å’Œ <code>Lock</code>ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹<strong>æ•°æ®åŠ é”</strong>ï¼ˆå¦‚ <code>MySQL</code> ä¸­çš„æ’å®ƒé”ï¼‰ã€‚</p><h2 id="å…¬å¹³é”ä¸éå…¬å¹³é”"><a href="#å…¬å¹³é”ä¸éå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”ä¸éå…¬å¹³é”"></a>å…¬å¹³é”ä¸éå…¬å¹³é”</h2><p>æ ¹æ®çº¿ç¨‹è·å–é”çš„æŠ¢å æœºåˆ¶ï¼Œé”å¯åˆ†ä¸ºå…¬å¹³é”ä¸éå…¬å¹³é”ã€‚</p><ul><li>å…¬å¹³é”è¡¨ç¤ºçº¿ç¨‹è·å–é”çš„é¡ºåºæ˜¯æŒ‰ç…§çº¿ç¨‹è¯·æ±‚é”çš„æ—¶é—´æ—©æ™šæ¥å†³å®šçš„ï¼Œä¹Ÿå°±æ˜¯æœ€æ—©è¯·æ±‚é”çš„çº¿ç¨‹å°†æœ€æ—©è·å–åˆ°é”ã€‚</li><li>éå…¬å¹³é”åœ¨è¿è¡Œæ—¶é—¯å…¥ï¼Œä¹Ÿå°±æ˜¯å…ˆæ¥ä¸ä¸€å®šå…ˆå¾—ï¼Œå¦‚ <code>synchronized</code>ã€‚</li><li><code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code>ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œä½†æ”¯æŒå…¬å¹³é”ã€‚</li><li>åœ¨æ²¡æœ‰å…¬å¹³æ€§éœ€æ±‚çš„æƒ…å†µä¸‹å°½é‡ä½¿ç”¨éå…¬å¹³é”ï¼Œå› ä¸ºå…¬å¹³é”ä¼šå¸¦æ¥æ€§èƒ½å¼€é”€ã€‚</li></ul><h2 id="ç‹¬å é”ä¸å…±äº«é”"><a href="#ç‹¬å é”ä¸å…±äº«é”" class="headerlink" title="ç‹¬å é”ä¸å…±äº«é”"></a>ç‹¬å é”ä¸å…±äº«é”</h2><p>æ ¹æ®é”åªèƒ½è¢«å•ä¸ªçº¿ç¨‹æŒæœ‰è¿˜æ˜¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹å…±åŒæŒæœ‰ï¼Œé”å¯åˆ†ä¸ºç‹¬å é”ä¸å…±äº«é”ã€‚</p><ul><li>ç‹¬å é”æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œæ¯æ¬¡è®¿é—®èµ„æºéƒ½åŠ ä¸Šäº†äº’æ–¥é”ï¼Œåœ¨åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¯»å–æ•°æ®ã€‚</li><li>å…±äº«é”æ˜¯ä¸€ç§ä¹è§‚é”ï¼Œå®ƒæ”¾å®½äº†åŠ é”çš„æ¡ä»¶ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œè¯»æ“ä½œã€‚</li></ul><h2 id="å¯é‡å…¥é”"><a href="#å¯é‡å…¥é”" class="headerlink" title="å¯é‡å…¥é”"></a>å¯é‡å…¥é”</h2><p>å½“ä¸€ä¸ªçº¿ç¨‹å†æ¬¡è·å–å®ƒå·²ç»è·å–çš„çæ—¶ï¼Œå¦‚æœä¸è¢«é˜»å¡ï¼Œé‚£ä¹ˆè¯¥é”æ˜¯å¯è¢«é‡å…¥çš„ã€‚</p><p><code>synchronized</code> å†…éƒ¨é”æ˜¯å¯é‡å…¥é”ï¼Œåœ¨å…¶å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªæ ‡ç¤ºï¼Œç”¨æ¥æ ‡ç¤ºè¯¥é”ç›®å‰è¢«å“ªä¸ªçº¿ç¨‹å ç”¨ï¼Œç„¶åå…³è”ä¸€ä¸ªè®¡æ•°å™¨ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†è¯¥é”æ—¶ï¼Œè®¡æ•°å™¨çš„å€¼ä¼šå˜æˆ <code>1</code>ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹å†æ¥è·å–è¯¥é”æ—¶ä¼šå‘ç°é”çš„æ‰€æœ‰è€…ä¸æ˜¯è‡ªå·±è€Œè¢«é˜»å¡æŒ‚èµ·ã€‚</p><p>ä½†æ˜¯å½“è·å–äº†è¯¥é”çš„çº¿ç¨‹å†æ¬¡è·å–é”æ—¶å‘ç°é”æ‹¥æœ‰è€…æ˜¯è‡ªå·±ï¼Œå°±ä¼šæŠŠè®¡æ•°å™¨å€¼ <code>+1</code>ï¼Œå½“é‡Šæ”¾é”åå€¼ <code>-1</code>ã€‚å½“è®¡æ•°å™¨å€¼ä¸º <code>0</code>ï¼Œçº¿ç¨‹æ ‡ç¤ºè¢«é‡ç½®ä¸º <code>null</code>ï¼Œè¿™æ—¶å€™è¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’æ¥ç«äº‰è¯¥é”ã€‚</p><h2 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h2><p>å½“å‰çº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœå‘ç°é”å·²è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œå®ƒä¸é©¬ä¸Šé˜»å¡è‡ªå·±ï¼Œåœ¨ä¸æ”¾å¼ƒ <code>CPU</code> ä½¿ç”¨æƒçš„æƒ…å†µä¸‹ï¼Œå¤šæ¬¡å°è¯•è·å–ï¼ˆé»˜è®¤10æ¬¡ï¼Œå¯ä»¥ä½¿ç”¨ <code>-XX:PreBlockSpinsh</code> å‚æ•°è®¾ç½®è¯¥å€¼ï¼‰ï¼Œå¾ˆæœ‰å¯èƒ½åœ¨åé¢å‡ æ¬¡å°è¯•ä¸­å…¶ä»–çº¿ç¨‹å·²ç»é‡Šæ”¾äº†é”ã€‚å¦‚æœå°è¯•æŒ‡å®šæ¬¡æ•°åä»æ²¡æœ‰è·å–åˆ°é”åˆ™å½“å‰çº¿ç¨‹æ‰ä¼šè¢«é˜»å¡æŒ‚èµ·ã€‚<br>è‡ªæ—‹é”æ˜¯ä½¿ç”¨ <code>CPU</code> æ—¶é—´æ¢å–çº¿ç¨‹é˜»å¡ä¸è°ƒåº¦çš„å¼€é”€ï¼Œä½†æ˜¯å¾ˆæœ‰å¯èƒ½è¿™äº› <code>CPU</code> æ—¶é—´ç™½ç™½æµªè´¹äº†ã€‚</p><h1 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h1><h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ç›¸äº’ç­‰å¾…çš„ç°è±¡ï¼Œåœ¨æ— å¤–åŠ›ä½œç”¨çš„æƒ…å†µä¸‹ï¼Œè¿™äº›çº¿ç¨‹ä¼šä¸€ç›´ç›¸äº’ç­‰å¾…è€Œæ— æ³•ç»§ç»­è¿è¡Œä¸‹å»</p><h2 id="åŸºæœ¬æ¡ä»¶"><a href="#åŸºæœ¬æ¡ä»¶" class="headerlink" title="åŸºæœ¬æ¡ä»¶"></a>åŸºæœ¬æ¡ä»¶</h2><ol><li>äº’æ–¥</li><li>è¯·æ±‚å¹¶æŒæœ‰</li><li>ä¸å¯å‰¥å¤º</li><li>ç¯è·¯ç­‰å¾…</li></ol><h2 id="é¿å…æ­»é”"><a href="#é¿å…æ­»é”" class="headerlink" title="é¿å…æ­»é”"></a>é¿å…æ­»é”</h2><blockquote><p>ä½¿ç”¨ç”³è¯·èµ„æºçš„æœ‰åºæ€§ï¼Œç ´åè¯·æ±‚å¹¶æŒæœ‰å’Œç¯è·¯ç­‰å¾…æ¡ä»¶ã€‚</p></blockquote><ul><li><p>é¿å…ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è·å–å¤šä¸ªé”ã€‚</p></li><li><p>é¿å…ä¸€ä¸ªçº¿ç¨‹åœ¨é”å†…åŒæ—¶å ç”¨å¤šä¸ªèµ„æºï¼Œå°½é‡ä¿è¯æ¯ä¸ªé”åªå ç”¨ä¸€ä¸ªèµ„æºã€‚</p></li><li><p>å°è¯•ä½¿ç”¨å®šæ—¶é” <code>lock.tryLock(timeout)</code>ï¼Œé¿å…é”ä¸€ç›´ä¸èƒ½é‡Šæ”¾ã€‚</p></li><li><p>å¯¹äºæ•°æ®åº“é”ï¼ŒåŠ é”å’Œè§£é”å¿…é¡»åœ¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥ä¸­é‡Œï¼Œå¦åˆ™ä¼šå‡ºç°è§£é”å¤±è´¥çš„æƒ…å†µã€‚</p></li></ul><h1 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h1><blockquote><p><code>AbstractQueuedSynchronizer</code>ï¼ˆç®€ç§° <code>AQS</code>ï¼‰æ˜¯é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œé¡¾åæ€ä¹‰ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å¤„ç†åŒæ­¥ã€‚å®ƒæ˜¯å¹¶å‘é”å’Œå¾ˆå¤šåŒæ­¥å·¥å…·ç±»çš„å®ç°åŸºçŸ³ï¼ˆå¦‚ <code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code>ã€<code>Semaphore</code> ç­‰ï¼‰ã€‚</p><p>å› æ­¤ï¼Œè¦æƒ³æ·±å…¥ç†è§£ <code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code> ç­‰å¹¶å‘é”å’ŒåŒæ­¥å·¥å…·ï¼Œå¿…é¡»å…ˆç†è§£ <code>AQS</code> çš„è¦ç‚¹å’ŒåŸç†ã€‚</p></blockquote><h2 id="AQS-çš„è¦ç‚¹"><a href="#AQS-çš„è¦ç‚¹" class="headerlink" title="AQS çš„è¦ç‚¹"></a><code>AQS</code> çš„è¦ç‚¹</h2><p>åœ¨ <code>java.util.concurrent.locks</code> åŒ…ä¸­çš„ç›¸å…³é”(å¸¸ç”¨çš„æœ‰ <code>ReentrantLock</code>ã€ <code>ReadWriteLock</code>)éƒ½æ˜¯åŸºäº <code>AQS</code> æ¥å®ç°ã€‚è¿™äº›é”éƒ½æ²¡æœ‰ç›´æ¥ç»§æ‰¿ <code>AQS</code>ï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€ä¸ª <code>Sync</code> ç±»å»ç»§æ‰¿ <code>AQS</code>ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Ÿå› ä¸ºé”é¢å‘çš„æ˜¯ä½¿ç”¨ç”¨æˆ·ï¼Œè€ŒåŒæ­¥å™¨é¢å‘çš„åˆ™æ˜¯çº¿ç¨‹æ§åˆ¶ï¼Œé‚£ä¹ˆåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨è€Œä¸æ˜¯ç›´æ¥ç»§æ‰¿ <code>AQS</code> å°±å¯ä»¥å¾ˆå¥½çš„éš”ç¦»äºŒè€…æ‰€å…³æ³¨çš„äº‹æƒ…ã€‚</p><p><strong><code>AQS</code> æä¾›äº†å¯¹ç‹¬äº«é”ä¸å…±äº«é”çš„æ”¯æŒã€‚</strong></p><h3 id="ç‹¬äº«é”-API"><a href="#ç‹¬äº«é”-API" class="headerlink" title="ç‹¬äº«é” API"></a>ç‹¬äº«é” <code>API</code></h3><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">acquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">acquireInterruptibly</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryAcquireNanos</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg, <span class="hljs-keyword">long</span> nanosTimeout)</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">release</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span></code></pre><ul><li><code>acquire</code> - è·å–ç‹¬å é”ã€‚</li><li><code>acquireInterruptibly</code> - è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚</li><li><code>tryAcquireNanos</code> - å°è¯•åœ¨æŒ‡å®šæ—¶é—´å†…è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹å›è¿”å›ï¼š<ul><li>åœ¨è¶…æ—¶æ—¶é—´å†…ï¼Œå½“å‰çº¿ç¨‹æˆåŠŸè·å–äº†é”ï¼›</li><li>å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è¢«ä¸­æ–­ï¼›</li><li>è¶…æ—¶æ—¶é—´ç»“æŸï¼Œä»æœªè·å¾—é”è¿”å› falseã€‚</li></ul></li><li><code>release</code> - é‡Šæ”¾ç‹¬å é”ã€‚</li></ul><h3 id="å…±äº«é”-API"><a href="#å…±äº«é”-API" class="headerlink" title="å…±äº«é” API"></a>å…±äº«é” <code>API</code></h3><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">acquireShared</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">acquireSharedInterruptibly</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryAcquireSharedNanos</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg, <span class="hljs-keyword">long</span> nanosTimeout)</span></span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">releaseShared</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span></span></code></pre><ul><li><code>acquireShared</code> - è·å–å…±äº«é”ã€‚</li><li><code>acquireSharedInterruptibly</code> - è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚</li><li><code>tryAcquireSharedNanos</code> - å°è¯•åœ¨æŒ‡å®šæ—¶é—´å†…è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚</li><li><code>release</code> - é‡Šæ”¾å…±äº«é”ã€‚</li></ul><h2 id="AQS-çš„åŸç†"><a href="#AQS-çš„åŸç†" class="headerlink" title="AQS çš„åŸç†"></a><code>AQS</code> çš„åŸç†</h2><h3 id="AQS-çš„æ•°æ®ç»“æ„"><a href="#AQS-çš„æ•°æ®ç»“æ„" class="headerlink" title="AQS çš„æ•°æ®ç»“æ„"></a><code>AQS</code> çš„æ•°æ®ç»“æ„</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractQueuedSynchronizer</span></span><span class="hljs-class">    <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractOwnableSynchronizer</span></span><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-comment">/** ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå¤´ï¼Œæ‡’åŠ è½½ã€‚åªèƒ½é€šè¿‡ setHead æ–¹æ³•ä¿®æ”¹ã€‚ */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node head;    <span class="hljs-comment">/** ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œæ‡’åŠ è½½ã€‚åªèƒ½é€šè¿‡ enq æ–¹æ³•æ·»åŠ æ–°çš„ç­‰å¾…èŠ‚ç‚¹ã€‚*/</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node tail;    <span class="hljs-comment">/** åŒæ­¥çŠ¶æ€ */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> state;&#125;</code></pre><ul><li><p><code>state</code> - <code>AQS</code> ä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„ <code>volatile</code> å˜é‡æ¥ ç»´æŠ¤åŒæ­¥çŠ¶æ€ã€‚</p><ul><li>è¿™ä¸ªæ•´æ•°çŠ¶æ€çš„æ„ä¹‰ç”±å­ç±»æ¥èµ‹äºˆï¼Œå¦‚ <code>ReentrantLock</code> ä¸­è¯¥çŠ¶æ€å€¼è¡¨ç¤ºæ‰€æœ‰è€…çº¿ç¨‹å·²ç»é‡å¤è·å–è¯¥é”çš„æ¬¡æ•°ï¼Œ<code>Semaphore</code> ä¸­è¯¥çŠ¶æ€å€¼è¡¨ç¤ºå‰©ä½™çš„è®¸å¯æ•°é‡ã€‚</li></ul></li><li><p><code>head</code> å’Œ <code>tail</code> - <code>AQS</code> ç»´æŠ¤äº†ä¸€ä¸ª <code>Node</code> ç±»å‹ï¼ˆ<code>AQS</code> çš„å†…éƒ¨ç±»ï¼‰çš„åŒé“¾è¡¨æ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†ã€‚è¿™ä¸ªåŒé“¾è¡¨æ˜¯ä¸€ä¸ªåŒå‘çš„ <code>FIFO</code> é˜Ÿåˆ—ï¼Œé€šè¿‡ <code>head</code> å’Œ <code>tail</code> æŒ‡é’ˆè¿›è¡Œè®¿é—®ã€‚å½“æœ‰çº¿ç¨‹è·å–é”å¤±è´¥åï¼Œå°±è¢«æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ã€‚</p></li></ul><p><img src="https://raw.githubusercontent.com/LikaiLee/likailee.github.io/img/20200718161601.png" srcset="/img/loading.gif" alt=""></p><p><code>Node</code> çš„æºç </p><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span> </span>&#123;    <span class="hljs-comment">/** è¯¥ç­‰å¾…åŒæ­¥çš„èŠ‚ç‚¹å¤„äºå…±äº«æ¨¡å¼ */</span>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Node SHARED = <span class="hljs-keyword">new</span> Node();    <span class="hljs-comment">/** è¯¥ç­‰å¾…åŒæ­¥çš„èŠ‚ç‚¹å¤„äºç‹¬å æ¨¡å¼ */</span>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Node EXCLUSIVE = <span class="hljs-keyword">null</span>;    <span class="hljs-comment">/** çº¿ç¨‹ç­‰å¾…çŠ¶æ€ï¼ŒçŠ¶æ€å€¼æœ‰: 0ã€1ã€-1ã€-2ã€-3 */</span>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> waitStatus;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CANCELLED =  <span class="hljs-number">1</span>;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SIGNAL    = -<span class="hljs-number">1</span>;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> CONDITION = -<span class="hljs-number">2</span>;    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PROPAGATE = -<span class="hljs-number">3</span>;    <span class="hljs-comment">/** å‰é©±èŠ‚ç‚¹ */</span>    <span class="hljs-keyword">volatile</span> Node prev;    <span class="hljs-comment">/** åç»§èŠ‚ç‚¹ */</span>    <span class="hljs-keyword">volatile</span> Node next;    <span class="hljs-comment">/** ç­‰å¾…é”çš„çº¿ç¨‹ */</span>    <span class="hljs-keyword">volatile</span> Thread thread;  <span class="hljs-comment">/** å’ŒèŠ‚ç‚¹æ˜¯å¦å…±äº«æœ‰å…³ */</span>    Node nextWaiter;&#125;</code></pre><p>å¾ˆæ˜¾ç„¶ï¼Œ<code>Node</code> æ˜¯ä¸€ä¸ªåŒé“¾è¡¨ç»“æ„ã€‚</p><p><code>waitStatus</code> - <code>Node</code> ä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„ <code>volatile</code> å˜é‡æ¥ ç»´æŠ¤ <code>AQS</code> åŒæ­¥é˜Ÿåˆ—ä¸­çº¿ç¨‹èŠ‚ç‚¹çš„çŠ¶æ€ã€‚<code>waitStatus</code> æœ‰äº”ä¸ªçŠ¶æ€å€¼ï¼š</p><ul><li><p><code>CANCELLED(1)</code> - æ­¤çŠ¶æ€è¡¨ç¤ºï¼šè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹å¯èƒ½ç”±äºè¶…æ—¶æˆ–è¢«ä¸­æ–­è€Œ <strong>å¤„äºè¢«å–æ¶ˆ(ä½œåºŸ)çŠ¶æ€</strong>ï¼Œä¸€æ—¦å¤„äºè¿™ä¸ªçŠ¶æ€ï¼Œè¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹åº”è¯¥ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</p></li><li><p><code>SIGNAL(-1)</code> - æ­¤çŠ¶æ€è¡¨ç¤ºï¼šåç»§èŠ‚ç‚¹ä¼šè¢«æŒ‚èµ·ï¼Œå› æ­¤åœ¨å½“å‰èŠ‚ç‚¹é‡Šæ”¾é”æˆ–è¢«å–æ¶ˆä¹‹åï¼Œå¿…é¡»å”¤é†’(<code>unparking</code>)å…¶åç»§ç»“ç‚¹ã€‚</p></li><li><p><code>CONDITION(-2)</code> - æ­¤çŠ¶æ€è¡¨ç¤ºï¼šè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹ å¤„äºç­‰å¾…æ¡ä»¶çŠ¶æ€ï¼Œä¸ä¼šè¢«å½“ä½œæ˜¯åŒæ­¥é˜Ÿåˆ—ä¸Šçš„èŠ‚ç‚¹ï¼Œç›´åˆ°è¢«å”¤é†’(<code>signal</code>)ï¼Œè®¾ç½®å…¶å€¼ä¸º 0ï¼Œå†é‡æ–°è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p></li><li><p><code>PROPAGATE(-3)</code> - æ­¤çŠ¶æ€è¡¨ç¤ºï¼šä¸‹ä¸€ä¸ª <code>acquireShared</code> åº”æ— æ¡ä»¶ä¼ æ’­ã€‚</p></li><li><p><code>0</code> - éä»¥ä¸ŠçŠ¶æ€ã€‚</p></li></ul><h3 id="ç‹¬å é”çš„è·å–å’Œé‡Šæ”¾"><a href="#ç‹¬å é”çš„è·å–å’Œé‡Šæ”¾" class="headerlink" title="ç‹¬å é”çš„è·å–å’Œé‡Šæ”¾"></a>ç‹¬å é”çš„è·å–å’Œé‡Šæ”¾</h3><h4 id="è·å–ç‹¬å é”"><a href="#è·å–ç‹¬å é”" class="headerlink" title="è·å–ç‹¬å é”"></a>è·å–ç‹¬å é”</h4><p><code>AQS</code> ä¸­ä½¿ç”¨ <code>acquire(int arg)</code> æ–¹æ³•è·å–ç‹¬å é”ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>å…ˆå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™ç»“æŸæ–¹æ³•ï¼Œç›´æ¥è¿”å›ã€‚</p></li><li><p>å¦‚æœè·å–åŒæ­¥çŠ¶æ€ä¸æˆåŠŸï¼Œ<code>AQS</code> ä¼šä¸æ–­å°è¯•åˆ©ç”¨ <code>CAS</code> æ“ä½œå°†å½“å‰çº¿ç¨‹æ’å…¥ç­‰å¾…åŒæ­¥é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚</p></li><li><p>æ¥ç€ï¼Œä¸æ–­å°è¯•ä¸ºç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹èŠ‚ç‚¹è·å–ç‹¬å é”ã€‚</p></li></ol><p><img src="https://raw.githubusercontent.com/LikaiLee/likailee.github.io/img/20200718161748.png" srcset="/img/loading.gif" alt=""><br><img src="https://raw.githubusercontent.com/LikaiLee/likailee.github.io/img/20200718162338.png" srcset="/img/loading.gif" alt=""><br>è¯¦ç»†æµç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼Œè¯·ç»“åˆæºç æ¥ç†è§£ï¼ˆä¸€å›¾èƒœåƒè¨€ï¼‰ï¼š<br><img src="https://raw.githubusercontent.com/LikaiLee/likailee.github.io/img/20200718162114.png" srcset="/img/loading.gif" alt=""></p><h4 id="é‡Šæ”¾ç‹¬å é”"><a href="#é‡Šæ”¾ç‹¬å é”" class="headerlink" title="é‡Šæ”¾ç‹¬å é”"></a>é‡Šæ”¾ç‹¬å é”</h4><p><code>AQS</code> ä¸­ä½¿ç”¨ <code>release(int arg)</code> æ–¹æ³•é‡Šæ”¾ç‹¬å é”ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>å…ˆå°è¯•è·å–è§£é”çº¿ç¨‹çš„åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–åŒæ­¥çŠ¶æ€ä¸æˆåŠŸï¼Œåˆ™ç»“æŸæ–¹æ³•ï¼Œç›´æ¥è¿”å›ã€‚</p></li><li><p>å¦‚æœè·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œ<code>AQS</code> ä¼šå°è¯•å”¤é†’å½“å‰çº¿ç¨‹èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚</p></li></ol><h4 id="è·å–å¯ä¸­æ–­çš„ç‹¬å é”"><a href="#è·å–å¯ä¸­æ–­çš„ç‹¬å é”" class="headerlink" title="è·å–å¯ä¸­æ–­çš„ç‹¬å é”"></a>è·å–å¯ä¸­æ–­çš„ç‹¬å é”</h4><p><code>AQS</code> ä¸­ä½¿ç”¨ <code>acquireInterruptibly(int arg)</code> æ–¹æ³•è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚</p><p><code>acquireInterruptibly(int arg)</code> å®ç°æ–¹å¼ç›¸è¾ƒäºè·å–ç‹¬å é”æ–¹æ³•ï¼ˆ<code>acquire</code>ï¼‰éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºå®ƒä¼šé€šè¿‡ <code>Thread.interrupted</code> æ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç«‹å³æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼ˆ<code>InterruptedException</code>ï¼‰ã€‚</p><h4 id="è·å–è¶…æ—¶ç­‰å¾…å¼çš„ç‹¬å é”"><a href="#è·å–è¶…æ—¶ç­‰å¾…å¼çš„ç‹¬å é”" class="headerlink" title="è·å–è¶…æ—¶ç­‰å¾…å¼çš„ç‹¬å é”"></a>è·å–è¶…æ—¶ç­‰å¾…å¼çš„ç‹¬å é”</h4><p><code>AQS</code> ä¸­ä½¿ç”¨ <code>tryAcquireNanos(int arg)</code> æ–¹æ³•è·å–è¶…æ—¶ç­‰å¾…çš„ç‹¬å é”ã€‚</p><p><code>doAcquireNanos</code> çš„å®ç°æ–¹å¼ ç›¸è¾ƒäºè·å–ç‹¬å é”æ–¹æ³•ï¼ˆ <code>acquire</code>ï¼‰éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå®ƒä¼šæ ¹æ®è¶…æ—¶æ—¶é—´å’Œå½“å‰æ—¶é—´è®¡ç®—å‡ºæˆªæ­¢æ—¶é—´ã€‚åœ¨è·å–é”çš„æµç¨‹ä¸­ï¼Œä¼šä¸æ–­åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œç›´æ¥è¿”å› <code>false</code>ï¼›å¦‚æœæ²¡è¶…æ—¶ï¼Œåˆ™ç”¨ <code>LockSupport.parkNanos</code> æ¥é˜»å¡å½“å‰çº¿ç¨‹ã€‚</p><h3 id="å…±äº«é”çš„è·å–å’Œé‡Šæ”¾"><a href="#å…±äº«é”çš„è·å–å’Œé‡Šæ”¾" class="headerlink" title="å…±äº«é”çš„è·å–å’Œé‡Šæ”¾"></a>å…±äº«é”çš„è·å–å’Œé‡Šæ”¾</h3><h4 id="è·å–å…±äº«é”"><a href="#è·å–å…±äº«é”" class="headerlink" title="è·å–å…±äº«é”"></a>è·å–å…±äº«é”</h4><p><code>AQS</code> ä¸­ä½¿ç”¨ <code>acquireShared(int arg)</code> æ–¹æ³•è·å–å…±äº«é”ã€‚</p><p><code>acquireShared</code> æ–¹æ³•å’Œ <code>acquire</code> æ–¹æ³•çš„é€»è¾‘å¾ˆç›¸ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºè‡ªæ—‹çš„æ¡ä»¶ä»¥åŠèŠ‚ç‚¹å‡ºé˜Ÿçš„æ“ä½œæœ‰æ‰€ä¸åŒã€‚</p><p>æˆåŠŸè·å¾—å…±äº«é”çš„æ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li><p><code>tryAcquireShared(arg)</code> è¿”å›å€¼å¤§äºç­‰äº <code>0</code> ï¼ˆè¿™æ„å‘³ç€å…±äº«é”çš„ permit è¿˜æ²¡æœ‰ç”¨å®Œï¼‰ã€‚</p></li><li><p>å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¤´ç»“ç‚¹ã€‚</p></li></ul><h4 id="é‡Šæ”¾å…±äº«é”"><a href="#é‡Šæ”¾å…±äº«é”" class="headerlink" title="é‡Šæ”¾å…±äº«é”"></a>é‡Šæ”¾å…±äº«é”</h4><p><code>AQS</code> ä¸­ä½¿ç”¨ <code>releaseShared(int arg)</code> æ–¹æ³•é‡Šæ”¾å…±äº«é”ã€‚</p><p><code>releaseShared</code> é¦–å…ˆä¼šå°è¯•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è§£é”ä¸€ä¸ªæˆ–å¤šä¸ªåç»§çº¿ç¨‹èŠ‚ç‚¹ã€‚é‡Šæ”¾å…±äº«é”å’Œé‡Šæ”¾ç‹¬äº«é”æµç¨‹å¤§ä½“ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼š</p><p>å¯¹äºç‹¬äº«æ¨¡å¼ï¼Œå¦‚æœéœ€è¦ <code>SIGNAL</code>ï¼Œé‡Šæ”¾ä»…ç›¸å½“äºè°ƒç”¨å¤´èŠ‚ç‚¹çš„ <code>unparkSuccessor</code>ã€‚</p><h4 id="è·å–å¯ä¸­æ–­çš„å…±äº«é”"><a href="#è·å–å¯ä¸­æ–­çš„å…±äº«é”" class="headerlink" title="è·å–å¯ä¸­æ–­çš„å…±äº«é”"></a>è·å–å¯ä¸­æ–­çš„å…±äº«é”</h4><p><code>AQS</code> ä¸­ä½¿ç”¨ <code>acquireSharedInterruptibly(int arg)</code> æ–¹æ³•è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚</p><p><code>acquireSharedInterruptibly</code> æ–¹æ³•ä¸ <code>acquireInterruptibly</code> å‡ ä¹ä¸€è‡´ï¼Œä¸å†èµ˜è¿°ã€‚</p><h4 id="è·å–è¶…æ—¶ç­‰å¾…å¼çš„å…±äº«é”"><a href="#è·å–è¶…æ—¶ç­‰å¾…å¼çš„å…±äº«é”" class="headerlink" title="è·å–è¶…æ—¶ç­‰å¾…å¼çš„å…±äº«é”"></a>è·å–è¶…æ—¶ç­‰å¾…å¼çš„å…±äº«é”</h4><p><code>AQS</code> ä¸­ä½¿ç”¨ <code>tryAcquireSharedNanos(int arg)</code> æ–¹æ³•è·å–è¶…æ—¶ç­‰å¾…å¼çš„å…±äº«é”ã€‚</p><p><code>tryAcquireSharedNanos</code> æ–¹æ³•ä¸ <code>tryAcquireNanos</code> å‡ ä¹ä¸€è‡´ï¼Œä¸å†èµ˜è¿°ã€‚</p><h1 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a><code>ReentrantLock</code></h1><blockquote><p><code>ReentrantLock</code> ç±»æ˜¯ <code>Lock</code> æ¥å£çš„å…·ä½“å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯é‡å…¥é”ã€‚ä¸å†…ç½®é” <code>synchronized</code> ä¸åŒï¼Œ<code>ReentrantLock</code> æä¾›äº†ä¸€ç»„æ— æ¡ä»¶çš„ã€å¯è½®è¯¢çš„ã€å®šæ—¶çš„ä»¥åŠå¯ä¸­æ–­çš„é”æ“ä½œï¼Œæ‰€æœ‰è·å–é”ã€é‡Šæ”¾é”çš„æ“ä½œéƒ½æ˜¯æ˜¾å¼çš„æ“ä½œã€‚</p></blockquote><h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><ul><li><p><code>ReentrantLock</code> æä¾›äº†ä¸ <code>synchronized</code> ç›¸åŒçš„äº’æ–¥æ€§ã€å†…å­˜å¯è§æ€§å’Œå¯é‡å…¥æ€§ã€‚</p></li><li><p><code>ReentrantLock</code> æ”¯æŒå…¬å¹³é”å’Œ<strong>éå…¬å¹³é”ï¼ˆé»˜è®¤ï¼‰</strong>ä¸¤ç§æ¨¡å¼ã€‚</p></li><li><p><code>ReentrantLock</code> å®ç°äº† <code>Lock</code> æ¥å£ï¼Œæ”¯æŒäº† <code>synchronized</code> æ‰€ä¸å…·å¤‡çš„çµæ´»æ€§ã€‚</p><ul><li><p>synchronized æ— æ³•ä¸­æ–­ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹</p></li><li><p>synchronized æ— æ³•åœ¨è¯·æ±‚è·å–ä¸€ä¸ªé”æ—¶æ— ä¼‘æ­¢åœ°ç­‰å¾…</p></li></ul></li></ul><p><code>Lcok</code> æ¥å£</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Lock</span> </span>&#123;    <span class="hljs-comment">// è·å–é”</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span></span>;    <span class="hljs-comment">// é”æœªè¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œä¸”çº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è·å–é”ã€‚</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;    <span class="hljs-comment">// å°è¯•è·å–é”ï¼Œä»…åœ¨è°ƒç”¨æ—¶é”æœªè¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„æƒ…å†µä¸‹ï¼Œæ‰è·å–è¯¥é”ã€‚</span>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span></span>;    <span class="hljs-comment">// å’Œ tryLock() ç±»ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºé™å®šæ—¶é—´ï¼Œå¦‚æœé™å®šæ—¶é—´å†…æœªè·å–åˆ°é”ï¼Œè§†ä¸ºå¤±è´¥ã€‚</span>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;    <span class="hljs-comment">// é‡Šæ”¾é”</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span></span>;    <span class="hljs-comment">// è¿”å›ä¸€ä¸ªç»‘å®šåˆ° Lock å¯¹è±¡ä¸Šçš„ Condition å®ä¾‹</span>    <span class="hljs-function">Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span></span>;&#125;</code></pre><h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ReentrantLock</span><span class="hljs-params">()</span> </span>&#123;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ReentrantLock</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> fair)</span> </span>&#123;&#125;</code></pre><ul><li><code>ReentrantLock()</code> - é»˜è®¤æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–ä¸€ä¸ªéå…¬å¹³é”ï¼ˆ<code>NonfairSync</code>ï¼‰ï¼›</li><li><code>ReentrantLock(boolean)</code> - <code>new ReentrantLock(true)</code> ä¼šåˆå§‹åŒ–ä¸€ä¸ªå…¬å¹³é”ï¼ˆ<code>FairSync</code>ï¼‰ã€‚</li></ul><h3 id="lock-å’Œ-unlock-æ–¹æ³•"><a href="#lock-å’Œ-unlock-æ–¹æ³•" class="headerlink" title="lock å’Œ unlock æ–¹æ³•"></a><code>lock</code> å’Œ <code>unlock</code> æ–¹æ³•</h3><ul><li><p><code>lock()</code> - <strong>æ— æ¡ä»¶è·å–é”</strong>ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ— æ³•è·å–é”ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ä¸å¯ç”¨ï¼Œç›´è‡³å½“å‰çº¿ç¨‹è·å–åˆ°é”ã€‚å¦‚æœè¯¥é”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™è·å–è¯¥é”å¹¶ç«‹å³è¿”å›ï¼Œå°†é”çš„æŒæœ‰è®¡æ•°è®¾ç½®ä¸º <code>1</code>ã€‚</p></li><li><p><code>unlock()</code> - ç”¨äºé‡Šæ”¾é”ã€‚</p><blockquote><p>ğŸ”” æ³¨æ„ï¼šè·å–é”æ“ä½œ <code>lock()</code> å¿…é¡»åœ¨ <code>try catch</code> å—ä¸­è¿›è¡Œï¼Œå¹¶ä¸”å°†é‡Šæ”¾é”æ“ä½œ <code>unlock()</code> æ”¾åœ¨ <code>finally</code> å—ä¸­è¿›è¡Œï¼Œä»¥ä¿è¯é”ä¸€å®šè¢«è¢«é‡Šæ”¾ï¼Œé˜²æ­¢æ­»é”çš„å‘ç”Ÿã€‚</p></blockquote></li></ul><h3 id="tryLock-æ–¹æ³•"><a href="#tryLock-æ–¹æ³•" class="headerlink" title="tryLock æ–¹æ³•"></a><code>tryLock</code> æ–¹æ³•</h3><p>ä¸æ— æ¡ä»¶è·å–é”ç›¸æ¯”ï¼Œ<code>tryLock</code> æœ‰æ›´å®Œå–„çš„å®¹é”™æœºåˆ¶ã€‚</p><ul><li><p><code>tryLock()</code> - å¯è½®è¯¢è·å–é”ã€‚å¦‚æœæˆåŠŸï¼Œåˆ™è¿”å› <code>true</code>ï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™è¿”å› <code>false</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•æ— è®ºæˆè´¥éƒ½ä¼š<strong>ç«‹å³è¿”å›</strong>ï¼Œè·å–ä¸åˆ°é”ï¼ˆé”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼‰æ—¶ä¸ä¼šä¸€ç›´ç­‰å¾…ã€‚</p></li><li><p><code>tryLock(long, TimeUnit)</code> - å¯å®šæ—¶è·å–é”ã€‚å’Œ <code>tryLock()</code> ç±»ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºè¿™ä¸ªæ–¹æ³•åœ¨è·å–ä¸åˆ°é”æ—¶ä¼šç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œåœ¨æ—¶é—´æœŸé™ä¹‹å†…å¦‚æœè¿˜è·å–ä¸åˆ°é”ï¼Œå°±è¿”å› <code>false</code>ã€‚å¦‚æœå¦‚æœä¸€å¼€å§‹æ‹¿åˆ°é”æˆ–è€…åœ¨ç­‰å¾…æœŸé—´å†…æ‹¿åˆ°äº†é”ï¼Œåˆ™è¿”å› <code>true</code>ã€‚</p></li></ul><h3 id="lockInterruptibly-æ–¹æ³•"><a href="#lockInterruptibly-æ–¹æ³•" class="headerlink" title="lockInterruptibly æ–¹æ³•"></a><code>lockInterruptibly</code> æ–¹æ³•</h3><p><code>lockInterruptibly()</code> - å¯ä¸­æ–­è·å–é”ã€‚å¯ä¸­æ–­è·å–é”å¯ä»¥åœ¨è·å¾—é”çš„åŒæ—¶ä¿æŒå¯¹ä¸­æ–­çš„å“åº”ã€‚å¯ä¸­æ–­è·å–é”æ¯”å…¶å®ƒè·å–é”çš„æ–¹å¼ç¨å¾®å¤æ‚ä¸€äº›ï¼Œéœ€è¦ä¸¤ä¸ª <code>try-catch</code> å—ï¼ˆå¦‚æœåœ¨è·å–é”çš„æ“ä½œä¸­æŠ›å‡ºäº† <code>InterruptedException</code> ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ <code>try-finally</code> åŠ é”æ¨¡å¼ï¼‰ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼šå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡ <code>lock.lockInterruptibly()</code> è·å–æŸä¸ªé”æ—¶ï¼Œè‹¥çº¿ç¨‹ <code>A</code> è·å–åˆ°äº†é”ï¼Œåˆ™çº¿ç¨‹ <code>B</code> åªèƒ½ç­‰å¾…ã€‚è‹¥æ­¤æ—¶å¯¹çº¿ç¨‹ <code>B</code> è°ƒç”¨ <code>threadB.interrupt()</code> æ–¹æ³•èƒ½å¤Ÿä¸­æ–­çº¿ç¨‹ <code>B</code> çš„ç­‰å¾…è¿‡ç¨‹ã€‚ç”±äº <code>lockInterruptibly()</code> çš„å£°æ˜ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œæ‰€ä»¥ <code>lock.lockInterruptibly()</code> å¿…é¡»æ”¾åœ¨ <code>try</code> å—ä¸­æˆ–è€…åœ¨è°ƒç”¨ <code>lockInterruptibly()</code> çš„æ–¹æ³•å¤–å£°æ˜æŠ›å‡º <code>InterruptedException</code>ã€‚</p><blockquote><p>ğŸ”” æ³¨æ„ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†é”ä¹‹åï¼Œæ˜¯ä¸ä¼šè¢« <code>interrupt()</code> æ–¹æ³•ä¸­æ–­çš„ã€‚å•ç‹¬è°ƒç”¨ <code>interrupt()</code> æ–¹æ³•ä¸èƒ½ä¸­æ–­æ­£åœ¨è¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹ï¼Œåªèƒ½ä¸­æ–­é˜»å¡çŠ¶æ€ä¸­çš„çº¿ç¨‹ã€‚å› æ­¤å½“é€šè¿‡ <code>lockInterruptibly()</code> æ–¹æ³•è·å–æŸä¸ªé”æ—¶ï¼Œå¦‚æœæœªè·å–åˆ°é”ï¼Œåªæœ‰åœ¨ç­‰å¾…çš„çŠ¶æ€ä¸‹ï¼Œæ‰å¯ä»¥å“åº”ä¸­æ–­ã€‚</p></blockquote><h3 id="newCondition-æ–¹æ³•"><a href="#newCondition-æ–¹æ³•" class="headerlink" title="newCondition æ–¹æ³•"></a><code>newCondition</code> æ–¹æ³•</h3><p><code>newCondition()</code> - è¿”å›ä¸€ä¸ªç»‘å®šåˆ° <code>Lock</code> å¯¹è±¡ä¸Šçš„ <code>Condition</code> å®ä¾‹ã€‚</p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><h3 id="ReentrantLock-çš„æ•°æ®ç»“æ„"><a href="#ReentrantLock-çš„æ•°æ®ç»“æ„" class="headerlink" title="ReentrantLock çš„æ•°æ®ç»“æ„"></a><code>ReentrantLock</code> çš„æ•°æ®ç»“æ„</h3><p>å®ƒæœ‰ä¸€ä¸ªæ ¸å¿ƒå­—æ®µï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;</code></pre><p><code>sync</code> - å†…éƒ¨æŠ½è±¡ç±» <code>ReentrantLock.Sync</code> å¯¹è±¡ï¼Œ<code>Sync</code> ç»§æ‰¿è‡ª <code>AQS</code>ã€‚å®ƒæœ‰ä¸¤ä¸ªå­ç±»ï¼š</p><ol><li><p><code>ReentrantLock.FairSync</code> - å…¬å¹³é”ã€‚</p></li><li><p><code>ReentrantLock.NonfairSync</code> - éå…¬å¹³é”ã€‚</p></li></ol><h3 id="è·å–é”å’Œé‡Šæ”¾é”"><a href="#è·å–é”å’Œé‡Šæ”¾é”" class="headerlink" title="è·å–é”å’Œé‡Šæ”¾é”"></a>è·å–é”å’Œé‡Šæ”¾é”</h3><p><code>ReentrantLock</code> è·å–é”å’Œé‡Šæ”¾é”çš„æ¥å£ï¼Œä»è¡¨è±¡çœ‹ï¼Œæ˜¯è°ƒç”¨ <code>ReentrantLock.FairSync</code> æˆ– <code>ReentrantLock.NonfairSync</code> ä¸­å„è‡ªçš„å®ç°ï¼›ä»æœ¬è´¨ä¸Šçœ‹ï¼Œæ˜¯åŸºäº <code>AQS</code> çš„å®ç°ã€‚</p><ul><li><p><code>void lock()</code> è°ƒç”¨ <code>Sync</code> çš„ <code>lock()</code> æ–¹æ³•ã€‚</p></li><li><p><code>void lockInterruptibly()</code> ç›´æ¥è°ƒç”¨ <code>AQS</code> çš„ è·å–å¯ä¸­æ–­çš„ç‹¬å é” æ–¹æ³• <code>lockInterruptibly()</code>ã€‚</p></li><li><p><code>boolean tryLock()</code> è°ƒç”¨ <code>Sync</code> çš„ <code>nonfairTryAcquire()</code> ã€‚</p></li><li><p><code>boolean tryLock(long time, TimeUnit unit)</code> ç›´æ¥è°ƒç”¨ <code>AQS</code> çš„ è·å–è¶…æ—¶ç­‰å¾…å¼çš„ç‹¬å é” æ–¹æ³• <code>tryAcquireNanos(int arg, long nanosTimeout)</code>ã€‚</p></li><li><p><code>void unlock()</code> ç›´æ¥è°ƒç”¨ <code>AQS</code> çš„ é‡Šæ”¾ç‹¬å é” æ–¹æ³• <code>release(int arg)</code> ã€‚</p></li></ul><h1 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a><code>ReentrantReadWriteLock</code></h1><blockquote><p><code>ReentrantReadWriteLock</code> ç±»æ˜¯ <code>ReadWriteLock</code> æ¥å£çš„å…·ä½“å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ª<strong>å¯é‡å…¥</strong>çš„è¯»å†™é”ã€‚<code>ReentrantReadWriteLock</code> ç»´æŠ¤äº†ä¸€å¯¹è¯»å†™é”ï¼Œå°†è¯»å†™é”åˆ†å¼€ï¼Œæœ‰åˆ©äºæé«˜å¹¶å‘æ•ˆç‡ã€‚</p></blockquote><p><code>ReentrantLock</code> å®ç°äº†ä¸€ç§æ ‡å‡†çš„äº’æ–¥é”ï¼šæ¯æ¬¡æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ <code>ReentrantLock</code>ã€‚ä½†å¯¹äºç»´æŠ¤æ•°æ®çš„å®Œæ•´æ€§æ¥è¯´ï¼Œäº’æ–¥é€šå¸¸æ˜¯ä¸€ç§è¿‡äºå¼ºç¡¬çš„åŠ é”ç­–ç•¥ï¼Œå› æ­¤ä¹Ÿå°±ä¸å¿…è¦åœ°é™åˆ¶äº†å¹¶å‘æ€§ã€‚å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œè¯»æ“ä½œæ¯”å†™æ“ä½œé¢‘ç¹ï¼Œåªè¦ä¿è¯æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½è¯»å–åˆ°æœ€æ–°æ•°æ®ï¼Œå¹¶ä¸”åœ¨è¯»æ•°æ®æ—¶ä¸ä¼šæœ‰å…¶å®ƒçº¿ç¨‹åœ¨ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚è¿™ç§ç­–ç•¥å‡å°‘äº†äº’æ–¥åŒæ­¥ï¼Œè‡ªç„¶ä¹Ÿæå‡äº†å¹¶å‘æ€§èƒ½ï¼Œ<code>ReentrantReadWriteLock</code> å°±æ˜¯è¿™ç§ç­–ç•¥çš„å…·ä½“å®ç°ã€‚</p><h2 id="ç‰¹æ€§-1"><a href="#ç‰¹æ€§-1" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><ul><li><p><code>ReentrantReadWriteLock</code> é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚å¦‚æœæ˜¯å†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œç”±äº <code>ReentrantReadWriteLock</code> å…¶å†…éƒ¨å®ç°æ¯” <code>ReentrantLock</code> å¤æ‚ï¼Œæ€§èƒ½å¯èƒ½åè€Œè¦å·®ä¸€äº›ã€‚å¦‚æœå­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚ç”±äº <code>ReentrantReadWriteLock</code> çš„è¯»å†™é”ï¼ˆ<code>ReadLock</code>ã€<code>WriteLock</code>ï¼‰éƒ½å®ç°äº† <code>Lock</code> æ¥å£ï¼Œæ‰€ä»¥è¦æ›¿æ¢ä¸º <code>ReentrantLock</code> ä¹Ÿè¾ƒä¸ºå®¹æ˜“ã€‚</p></li><li><p><code>ReentrantReadWriteLock</code> å®ç°äº† <code>ReadWriteLock</code> æ¥å£ï¼Œæ”¯æŒäº† <code>ReentrantLock</code> æ‰€ä¸å…·å¤‡çš„è¯»å†™é”åˆ†ç¦»ã€‚<code>ReentrantReadWriteLock</code> ç»´æŠ¤äº†ä¸€å¯¹è¯»å†™é”ï¼ˆ<code>ReadLock</code>ã€<code>WriteLock</code>ï¼‰ã€‚å°†è¯»å†™é”åˆ†å¼€ï¼Œæœ‰åˆ©äºæé«˜å¹¶å‘æ•ˆç‡ã€‚<code>ReentrantReadWriteLock</code> çš„åŠ é”ç­–ç•¥æ˜¯ï¼š<strong>å…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œä½†æ¯æ¬¡åªå…è®¸ä¸€ä¸ªå†™æ“ä½œ</strong>ã€‚</p></li><li><p><code>ReentrantReadWriteLock</code> ä¸ºè¯»å†™é”éƒ½æä¾›äº†å¯é‡å…¥çš„åŠ é”è¯­ä¹‰ã€‚</p></li><li><p><code>ReentrantReadWriteLock</code> æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ï¼ˆé»˜è®¤ï¼‰ä¸¤ç§æ¨¡å¼ã€‚</p></li></ul><p><code>ReadWriteLock</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ReadWriteLock</span> </span>&#123;    <span class="hljs-comment">// è¿”å›ç”¨äºè¯»æ“ä½œçš„é”</span>    <span class="hljs-function">Lock <span class="hljs-title">readLock</span><span class="hljs-params">()</span></span>;    <span class="hljs-comment">// è¿”å›ç”¨äºå†™æ“ä½œçš„é”</span>    <span class="hljs-function">Lock <span class="hljs-title">writeLock</span><span class="hljs-params">()</span></span>;&#125;</code></pre><h2 id="ç”¨æ³•-1"><a href="#ç”¨æ³•-1" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><h3 id="æ„é€ æ–¹æ³•-1"><a href="#æ„é€ æ–¹æ³•-1" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ReentrantReadWriteLock</span><span class="hljs-params">()</span> </span>&#123;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ReentrantReadWriteLock</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> fair)</span> </span>&#123;&#125;</code></pre><ul><li><p><code>ReentrantReadWriteLock()</code> - é»˜è®¤æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–ä¸€ä¸ªéå…¬å¹³é”ï¼ˆ<code>NonfairSync</code>ï¼‰ã€‚åœ¨éå…¬å¹³çš„é”ä¸­ï¼Œçº¿ç¨‹è·å¾—é”çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚å†™çº¿ç¨‹é™çº§ä¸ºè¯»çº¿ç¨‹æ˜¯å¯ä»¥çš„ï¼Œä½†è¯»çº¿ç¨‹å‡çº§ä¸ºå†™çº¿ç¨‹æ˜¯ä¸å¯ä»¥çš„ï¼ˆè¿™æ ·ä¼šå¯¼è‡´æ­»é”ï¼‰ã€‚</p></li><li><p><code>ReentrantReadWriteLock(boolean)</code> - <code>new ReentrantLock(true)</code> ä¼šåˆå§‹åŒ–ä¸€ä¸ªå…¬å¹³é”ï¼ˆ<code>FairSync</code>ï¼‰ã€‚å¯¹äºå…¬å¹³é”ï¼Œç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹å°†ä¼˜å…ˆè·å¾—é”ã€‚å¦‚æœè¿™ä¸ªé”æ˜¯è¯»çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å¦ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™é”ï¼Œé‚£ä¹ˆå…¶ä»–è¯»çº¿ç¨‹éƒ½ä¸èƒ½è·å¾—è¯»é”ï¼Œç›´åˆ°å†™çº¿ç¨‹é‡Šæ”¾å†™é”ã€‚</p></li></ul><h3 id="ä½¿ç”¨å®ä¾‹"><a href="#ä½¿ç”¨å®ä¾‹" class="headerlink" title="ä½¿ç”¨å®ä¾‹"></a>ä½¿ç”¨å®ä¾‹</h3><p><code>ReentrantReadWriteLock</code> ä¸ <code>ReentrantLock</code> ç”¨æ³•ä¸Šçš„å·®å¼‚ï¼Œä¸»è¦åœ¨äº<strong>è¯»å†™é”çš„é…åˆä½¿ç”¨</strong>ã€‚æœ¬æ–‡ä»¥ä¸€ä¸ªå…¸å‹ä½¿ç”¨åœºæ™¯æ¥è¿›è¡Œè®²è§£ã€‚</p><p>ç¤ºä¾‹ï¼šåŸºäº <code>ReentrantReadWriteLock</code> å®ç°ä¸€ä¸ªç®€å•çš„æœ¬åœ°ç¼“å­˜</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ç®€å•çš„æ— ç•Œç¼“å­˜å®ç°</span><span class="hljs-comment"> * &lt;p&gt;</span><span class="hljs-comment"> * ä½¿ç”¨ WeakHashMap å­˜å‚¨é”®å€¼å¯¹ã€‚WeakHashMap ä¸­å­˜å‚¨çš„å¯¹è±¡æ˜¯å¼±å¼•ç”¨ï¼ŒJVM GC æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤æ²¡æœ‰è¢«å¼•ç”¨çš„å¼±å¼•ç”¨å¯¹è±¡ã€‚</span><span class="hljs-comment"> */</span><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UnboundedCache</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;K, V&gt; cacheMap = <span class="hljs-keyword">new</span> WeakHashMap&lt;&gt;();    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantReadWriteLock cacheLock = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">get</span><span class="hljs-params">(K key)</span> </span>&#123;        cacheLock.readLock().lock();        V value;        <span class="hljs-keyword">try</span> &#123;            value = cacheMap.get(key);            String log = String.format(<span class="hljs-string">"%s è¯»æ•°æ® %s:%s"</span>, Thread.currentThread().getName(), key, value);            System.out.println(log);        &#125; <span class="hljs-keyword">finally</span> &#123;            cacheLock.readLock().unlock();        &#125;        <span class="hljs-keyword">return</span> value;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;        cacheLock.writeLock().lock();        <span class="hljs-keyword">try</span> &#123;            cacheMap.put(key, value);            String log = String.format(<span class="hljs-string">"%s å†™å…¥æ•°æ® %s:%s"</span>, Thread.currentThread().getName(), key, value);            System.out.println(log);        &#125; <span class="hljs-keyword">finally</span> &#123;            cacheLock.writeLock().unlock();        &#125;        <span class="hljs-keyword">return</span> value;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">remove</span><span class="hljs-params">(K key)</span> </span>&#123;        cacheLock.writeLock().lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">return</span> cacheMap.remove(key);        &#125; <span class="hljs-keyword">finally</span> &#123;            cacheLock.writeLock().unlock();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span> </span>&#123;        cacheLock.writeLock().lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-keyword">this</span>.cacheMap.clear();        &#125; <span class="hljs-keyword">finally</span> &#123;            cacheLock.writeLock().unlock();        &#125;    &#125;&#125;</code></pre><ul><li><p>ä½¿ç”¨ <code>WeakHashMap</code> è€Œä¸æ˜¯ <code>HashMap</code> æ¥å­˜å‚¨é”®å€¼å¯¹ã€‚<code>WeakHashMap</code> ä¸­å­˜å‚¨çš„å¯¹è±¡æ˜¯å¼±å¼•ç”¨ï¼Œ<code>JVM GC</code> æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤æ²¡æœ‰è¢«å¼•ç”¨çš„å¼±å¼•ç”¨å¯¹è±¡ã€‚</p></li><li><p>å‘ Map å†™æ•°æ®å‰åŠ å†™é”ï¼Œå†™å®Œåï¼Œé‡Šæ”¾å†™é”ã€‚</p></li><li><p>å‘ Map è¯»æ•°æ®å‰åŠ è¯»é”ï¼Œè¯»å®Œåï¼Œé‡Šæ”¾è¯»é”ã€‚</p></li></ul><h2 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h2><h3 id="ReentrantReadWriteLock-çš„æ•°æ®ç»“æ„"><a href="#ReentrantReadWriteLock-çš„æ•°æ®ç»“æ„" class="headerlink" title="ReentrantReadWriteLock çš„æ•°æ®ç»“æ„"></a><code>ReentrantReadWriteLock</code> çš„æ•°æ®ç»“æ„</h3><pre><code class="hljs java"><span class="hljs-comment">/** Inner class providing readlock */</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;<span class="hljs-comment">/** Inner class providing writelock */</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;<span class="hljs-comment">/** Performs all synchronization mechanics */</span><span class="hljs-keyword">final</span> Sync sync;<span class="hljs-keyword">public</span> ReentrantReadWriteLock.<span class="hljs-function">WriteLock <span class="hljs-title">writeLock</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> writerLock; &#125;<span class="hljs-keyword">public</span> ReentrantReadWriteLock.<span class="hljs-function">ReadLock  <span class="hljs-title">readLock</span><span class="hljs-params">()</span>  </span>&#123; <span class="hljs-keyword">return</span> readerLock; &#125;</code></pre><ul><li><p><code>sync</code> - å†…éƒ¨ç±» <code>ReentrantReadWriteLock.Sync</code> å¯¹è±¡ã€‚ä¸ <code>ReentrantLock</code> ç±»ä¼¼ï¼Œå®ƒæœ‰ä¸¤ä¸ªå­ç±»ï¼š<code>ReentrantReadWriteLock.FairSync</code> å’Œ <code>ReentrantReadWriteLock.NonfairSync</code> ï¼Œåˆ†åˆ«è¡¨ç¤ºå…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°ã€‚</p></li><li><p><code>readerLock</code> - å†…éƒ¨ç±» <code>ReentrantReadWriteLock.ReadLock</code> å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€æŠŠè¯»é”ã€‚</p></li><li><p><code>writerLock</code> - å†…éƒ¨ç±» <code>ReentrantReadWriteLock.WriteLock</code> å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€æŠŠå†™é”ã€‚</p></li></ul><h3 id="è·å–é”å’Œé‡Šæ”¾é”-1"><a href="#è·å–é”å’Œé‡Šæ”¾é”-1" class="headerlink" title="è·å–é”å’Œé‡Šæ”¾é”"></a>è·å–é”å’Œé‡Šæ”¾é”</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span>, <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-comment">// è°ƒç”¨ AQS è·å–å…±äº«é”æ–¹æ³•</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;        sync.acquireShared(<span class="hljs-number">1</span>);    &#125;    <span class="hljs-comment">// è°ƒç”¨ AQS é‡Šæ”¾å…±äº«é”æ–¹æ³•</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;        sync.releaseShared(<span class="hljs-number">1</span>);    &#125;&#125;<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WriteLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span>, <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-comment">// è°ƒç”¨ AQS è·å–ç‹¬å é”æ–¹æ³•</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;        sync.acquire(<span class="hljs-number">1</span>);    &#125;    <span class="hljs-comment">// è°ƒç”¨ AQS é‡Šæ”¾ç‹¬å é”æ–¹æ³•</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;        sync.release(<span class="hljs-number">1</span>);    &#125;&#125;</code></pre><h1 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h1><p><code>Java 1.5</code> ä¹‹å‰ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ <code>Object</code> ç±»ä¸­çš„ <code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code> é…åˆ <code>synchronized</code> æ¥è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ã€‚</p><p><code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code> éœ€è¦é…åˆ <code>synchronized</code> ä½¿ç”¨ï¼Œä¸é€‚ç”¨äº <code>Lock</code>ã€‚è€Œä½¿ç”¨ <code>Lock</code> çš„çº¿ç¨‹ï¼Œå½¼æ­¤é—´é€šä¿¡åº”è¯¥ä½¿ç”¨ <code>Condition</code>ã€‚<br>è¿™å¯ä»¥ç†è§£ä¸ºï¼Œä»€ä¹ˆæ ·çš„é”é…ä»€ä¹ˆæ ·çš„é’¥åŒ™ã€‚å†…ç½®é”ï¼ˆ<code>synchronized</code>ï¼‰é…åˆå†…ç½®æ¡ä»¶é˜Ÿåˆ—ï¼ˆ<code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code>ï¼‰ï¼Œæ˜¾å¼é”ï¼ˆ<code>Lock</code>ï¼‰é…åˆæ˜¾å¼æ¡ä»¶é˜Ÿåˆ—ï¼ˆ<code>Condition</code>ï¼‰ã€‚</p><h2 id="ç‰¹æ€§-2"><a href="#ç‰¹æ€§-2" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Condition</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">awaitUninterruptibly</span><span class="hljs-params">()</span></span>;    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">awaitNanos</span><span class="hljs-params">(<span class="hljs-keyword">long</span> nanosTimeout)</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">await</span><span class="hljs-params">(<span class="hljs-keyword">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">awaitUntil</span><span class="hljs-params">(Date deadline)</span> <span class="hljs-keyword">throws</span> InterruptedException</span>;    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">signal</span><span class="hljs-params">()</span></span>;    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">signalAll</span><span class="hljs-params">()</span></span>;&#125;</code></pre><p>å…¶ä¸­ï¼Œ<code>await</code>ã€<code>signal</code>ã€<code>signalAll</code> ä¸ <code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code> ç›¸å¯¹åº”ï¼ŒåŠŸèƒ½ä¹Ÿç›¸ä¼¼ã€‚é™¤æ­¤ä»¥å¤–ï¼Œ<code>Condition</code> ç›¸æ¯”å†…ç½®æ¡ä»¶é˜Ÿåˆ—ï¼ˆ<code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code>ï¼‰ï¼Œæä¾›äº†æ›´ä¸ºä¸°å¯Œçš„åŠŸèƒ½ï¼š</p><ul><li><p>æ¯ä¸ªé”ï¼ˆ<code>Lock</code>ï¼‰ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ª <code>Condition</code>ï¼Œè¿™æ„å‘³ç€é”çš„çŠ¶æ€æ¡ä»¶å¯ä»¥æœ‰å¤šä¸ªã€‚</p></li><li><p>æ”¯æŒå…¬å¹³çš„æˆ–éå…¬å¹³çš„é˜Ÿåˆ—æ“ä½œã€‚</p></li><li><p>æ”¯æŒå¯ä¸­æ–­çš„æ¡ä»¶ç­‰å¾…ï¼Œç›¸å…³æ–¹æ³•ï¼š<code>awaitUninterruptibly()</code>ã€‚</p></li><li><p>æ”¯æŒå¯å®šæ—¶çš„ç­‰å¾…ï¼Œç›¸å…³æ–¹æ³•ï¼š<code>awaitNanos(long)</code> ã€<code>await(long, TimeUnit)</code>ã€<code>awaitUntil(Date)</code>ã€‚</p></li></ul><h2 id="ç”¨æ³•-2"><a href="#ç”¨æ³•-2" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p>è¿™é‡Œä»¥ <code>Condition</code> æ¥å®ç°ä¸€ä¸ªæ¶ˆè´¹è€…ã€ç”Ÿäº§è€…æ¨¡å¼ã€‚</p><blockquote><p>ğŸ”” æ³¨æ„ï¼šäº‹å®ä¸Šï¼Œè§£å†³æ­¤ç±»é—®é¢˜ä½¿ç”¨ <code>CountDownLatch</code>ã€<code>Semaphore</code> ç­‰å·¥å…·æ›´ä¸ºä¾¿æ·ã€å®‰å…¨ã€‚</p></blockquote><p>æ¶ˆæ¯ç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Message</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Condition consumeCondition = lock.newCondition();    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Condition produceCondition = lock.newCondition();    <span class="hljs-keyword">private</span> String message;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> state;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> end;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consume</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">//lock</span>        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// no new message wait for new message</span>            <span class="hljs-keyword">while</span> (!state) &#123;                consumeCondition.await();            &#125;            System.out.println(<span class="hljs-string">"consume message : "</span> + message);            state = <span class="hljs-keyword">false</span>;            <span class="hljs-comment">// message consumed, notify waiting thread</span>            produceCondition.signal();        &#125; <span class="hljs-keyword">catch</span> (InterruptedException ie) &#123;            System.out.println(<span class="hljs-string">"Thread interrupted - viewMessage"</span>);        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">(String message)</span> </span>&#123;        lock.lock();        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">// last message not consumed, wait for it be consumed</span>            <span class="hljs-keyword">while</span> (state) &#123;                produceCondition.await();            &#125;            System.out.println(<span class="hljs-string">"produce msg: "</span> + message);            <span class="hljs-keyword">this</span>.message = message;            state = <span class="hljs-keyword">true</span>;            <span class="hljs-comment">// new message added, notify waiting thread</span>            consumeCondition.signal();        &#125; <span class="hljs-keyword">catch</span> (InterruptedException ie) &#123;            System.out.println(<span class="hljs-string">"Thread interrupted - publishMessage"</span>);        &#125; <span class="hljs-keyword">finally</span> &#123;            lock.unlock();        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isEnd</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> end;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEnd</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> end)</span> </span>&#123;        <span class="hljs-keyword">this</span>.end = end;    &#125;&#125;</code></pre><p>ç”Ÿäº§è€…ï¼š</p><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageProducer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;    <span class="hljs-keyword">private</span> Message message;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MessageProducer</span><span class="hljs-params">(Message msg)</span> </span>&#123;        message = msg;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;        produce();    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span> </span>&#123;        List&lt;String&gt; msgs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();        msgs.add(<span class="hljs-string">"Begin"</span>);        msgs.add(<span class="hljs-string">"Msg1"</span>);        msgs.add(<span class="hljs-string">"Msg2"</span>);        <span class="hljs-keyword">for</span> (String msg : msgs) &#123;            message.produce(msg);            <span class="hljs-keyword">try</span> &#123;                Thread.sleep(<span class="hljs-number">100</span>);            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;                e.printStackTrace();            &#125;        &#125;        message.produce(<span class="hljs-string">"End"</span>);        message.setEnd(<span class="hljs-keyword">true</span>);    &#125;&#125;</code></pre><p>æ¶ˆè´¹è€…ï¼š</p><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;    <span class="hljs-keyword">private</span> Message message;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MessageConsumer</span><span class="hljs-params">(Message msg)</span> </span>&#123;        message = msg;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">while</span> (!message.isEnd()) &#123; message.consume(); &#125;    &#125;&#125;</code></pre><p>æµ‹è¯•ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LockConditionDemo</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        Message msg = <span class="hljs-keyword">new</span> Message();        Thread producer = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> MessageProducer(msg));        Thread consumer = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> MessageConsumer(msg));        producer.start();        consumer.start();    &#125;&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>å¹¶å‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¹¶å‘</tag>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Overview</title>
    <link href="/2018/12/28/overview/"/>
    <url>/2018/12/28/overview/</url>
    
    <content type="html"><![CDATA[<p>During the past six months, I was focusing on preparing for the entrance exam of postgraduate schools, owing to that, I could barely write posts or sorting out my blog. Whatâ€™s worse, I figured out that I got my server expired and lost most of my posts that I have written in the almost past three years, in which I have made some records in my study and lives, including programming thoughts and life experiences.</p><p>As youâ€™ll find out, I plan to migrate my blog from cloud server to git pages, itâ€™s kind of a large project. Thanks to the exam which I have mentioned above, actually I did not expect that I could spend a surprisingly large amount of time in concentrating on one thing. Itâ€™s helpful in building up a hard-working, persistent personality.</p><p>In short, now that Iâ€™ve finished my exam, I plan to get a vacation for a couple of weeks and then back to my blogâ€™s migration.</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
