<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Likai Lee">
  <meta name="keywords" content="">
  <title>å¹¶å‘-å®¹å™¨ - Likai Lee</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Likai Lee</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/bg/1.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
                å¹¶å‘-å®¹å™¨
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-07-24 15:52">
      2020å¹´7æœˆ24æ—¥ ä¸‹åˆ
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.3k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      44
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="åŒæ­¥å®¹å™¨"><a href="#åŒæ­¥å®¹å™¨" class="headerlink" title="åŒæ­¥å®¹å™¨"></a>åŒæ­¥å®¹å™¨</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>åœ¨ <code>Java</code> ä¸­ï¼ŒåŒæ­¥å®¹å™¨ä¸»è¦åŒ…æ‹¬ <code>2</code> ç±»ï¼š</p>
<ul>
<li><p><code>Vector</code>, <code>Stack</code>, <code>HashTable</code></p>
<ul>
<li><code>Vector</code> - <code>Vector</code> å®ç°äº† <code>List</code> æ¥å£ã€‚<code>Vector</code> å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå’Œ <code>ArrayList</code> ç±»ä¼¼ã€‚ä½†æ˜¯ <code>Vector</code> ä¸­çš„æ–¹æ³•éƒ½æ˜¯ <code>synchronized</code> æ–¹æ³•ï¼Œå³è¿›è¡Œäº†åŒæ­¥æªæ–½ã€‚</li>
<li><code>Stack</code> - <code>Stack</code> ç»§æ‰¿äº <code>Vector</code> ç±»ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåŒæ­¥å®¹å™¨ï¼Œå®ƒçš„æ–¹æ³•ä¹Ÿç”¨ <code>synchronized</code> è¿›è¡Œäº†åŒæ­¥ã€‚</li>
<li><code>Hashtable</code>- <code>Hashtable</code> å®ç°äº† <code>Map</code> æ¥å£ï¼Œä½†æ˜¯ <code>Hashtable</code> ç”¨ <code>synchronized</code> è¿›è¡Œäº†åŒæ­¥ã€‚</li>
</ul>
</li>
<li><p><code>Collections</code> ç±»ä¸­æä¾›çš„é™æ€å·¥å‚æ–¹æ³•åˆ›å»ºçš„ç±»ï¼ˆç”± <code>Collections.synchronizedXXX</code> ç­‰æ–¹æ³•ï¼‰ã€‚</p>
</li>
</ul>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>åŒæ­¥å®¹å™¨çš„åŒæ­¥åŸç†å°±æ˜¯åœ¨æ–¹æ³•ä¸Šç”¨ <code>synchronized</code> ä¿®é¥°ã€‚</p>
<h3 id="æ€§èƒ½é—®é¢˜"><a href="#æ€§èƒ½é—®é¢˜" class="headerlink" title="æ€§èƒ½é—®é¢˜"></a>æ€§èƒ½é—®é¢˜</h3><p><code>synchronized</code> çš„äº’æ–¥åŒæ­¥ä¼šäº§ç”Ÿé˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„å¼€é”€ã€‚æ˜¾ç„¶ï¼Œè¿™ç§æ–¹å¼æ¯”æ²¡æœ‰ä½¿ç”¨ <code>synchronized</code> çš„å®¹å™¨æ€§èƒ½è¦å·®ã€‚</p>
<h3 id="å®‰å…¨é—®é¢˜"><a href="#å®‰å…¨é—®é¢˜" class="headerlink" title="å®‰å…¨é—®é¢˜"></a>å®‰å…¨é—®é¢˜</h3><p>åŒæ­¥å®¹å™¨çœŸçš„ç»å¯¹å®‰å…¨å—ï¼Ÿ</p>
<p>å…¶å®ä¹Ÿæœªå¿…ã€‚åœ¨åšå¤åˆæ“ä½œï¼ˆéåŸå­æ“ä½œï¼‰æ—¶ï¼Œä»ç„¶éœ€è¦åŠ é”æ¥ä¿æŠ¤ã€‚å¸¸è§å¤åˆæ“ä½œå¦‚ä¸‹ï¼š</p>
<ul>
<li><p>è¿­ä»£ï¼šåå¤è®¿é—®å…ƒç´ ï¼Œç›´åˆ°éå†å®Œå…¨éƒ¨å…ƒç´ ï¼›</p>
</li>
<li><p>è·³è½¬ï¼šæ ¹æ®æŒ‡å®šé¡ºåºå¯»æ‰¾å½“å‰å…ƒç´ çš„ä¸‹ä¸€ä¸ªï¼ˆä¸‹ <code>n</code> ä¸ªï¼‰å…ƒç´ ï¼›</p>
</li>
<li><p>æ¡ä»¶è¿ç®—ï¼šä¾‹å¦‚è‹¥æ²¡æœ‰åˆ™æ·»åŠ ç­‰ï¼›</p>
</li>
</ul>
<p>âŒ ä¸å®‰å…¨çš„ç¤ºä¾‹</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@author</span> likailee.llk</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@version</span> : ConcurrentContainerTest.java 2020/07/24 Fri 1:56 PM likai</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcurrentContainerTest</span> </span>&#123;
    <span class="hljs-keyword">static</span> Vector&lt;Integer&gt; vector = <span class="hljs-keyword">new</span> Vector&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;
            vector.clear();

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;
                vector.add(i);
            &#125;
            Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++) &#123;
                    vector.remove(i);
                &#125;
            &#125;);

            Thread t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++) &#123;
                    vector.get(i);
                &#125;
            &#125;);

            t1.start();
            t2.start();

            <span class="hljs-keyword">while</span> (Thread.activeCount() &gt; <span class="hljs-number">10</span>) &#123;
                System.out.println(<span class="hljs-string">"åŒæ—¶å­˜åœ¨åä¸ªä»¥ä¸Šçº¿ç¨‹ï¼Œ é€€å‡º"</span>);
                <span class="hljs-keyword">return</span>;
            &#125;
        &#125;
    &#125;
&#125;</code></pre>
<p>ä»¥ä¸Šç¨‹åºæ‰§è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°æ•°ç»„è¶Šç•Œé”™è¯¯ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºï¼Œå¯¹äº <code>Vector</code>ï¼Œè™½ç„¶èƒ½ä¿è¯æ¯ä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å®ƒï¼Œä½†æ˜¯ä¸æ’é™¤è¿™ç§å¯èƒ½ï¼š<br>å½“æŸä¸ªçº¿ç¨‹è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»åˆ é™¤äº†è¯¥çº¿ç¨‹æ‰€è¦è¯»çš„é‚£ä¸ªå…ƒç´ ã€‚</p>
<p>å› æ­¤ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¿…é¡»åœ¨æ–¹æ³•è°ƒç”¨ç«¯åšé¢å¤–çš„åŒæ­¥æªæ–½ï¼Œå¦‚ä¸‹é¢æ‰€ç¤ºï¼š</p>
<pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (vector) &#123;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++) &#123;
        vector.remove(i);
    &#125;
&#125;

<span class="hljs-keyword">synchronized</span> (vector) &#123;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; vector.size(); i++) &#123;
        vector.remove(i);
    &#125;
&#125;</code></pre>

<h1 id="å¹¶å‘å®¹å™¨ç®€ä»‹"><a href="#å¹¶å‘å®¹å™¨ç®€ä»‹" class="headerlink" title="å¹¶å‘å®¹å™¨ç®€ä»‹"></a>å¹¶å‘å®¹å™¨ç®€ä»‹</h1><blockquote>
<p>åŒæ­¥å®¹å™¨å°†æ‰€æœ‰å¯¹å®¹å™¨çŠ¶æ€çš„è®¿é—®éƒ½ä¸²è¡ŒåŒ–ï¼Œä»¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œè¿™ç§ç­–ç•¥ä¼šä¸¥é‡é™ä½å¹¶å‘æ€§ã€‚</p>
<p>Java 1.5 åæä¾›äº†å¤šç§å¹¶å‘å®¹å™¨ï¼Œä½¿ç”¨å¹¶å‘å®¹å™¨æ¥æ›¿ä»£åŒæ­¥å®¹å™¨ï¼Œå¯ä»¥æå¤§åœ°æé«˜ä¼¸ç¼©æ€§å¹¶é™ä½é£é™©ã€‚</p>
</blockquote>
<p>J.U.C åŒ…ä¸­æä¾›äº†å‡ ä¸ªéå¸¸æœ‰ç”¨çš„å¹¶å‘å®¹å™¨ä½œä¸ºçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼š</p>
<table>
<thead>
<tr>
<th align="center">å¹¶å‘å®¹å™¨</th>
<th align="center">å¯¹åº”çš„æ™®é€šå®¹å™¨</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>ConcurrentHashMap</code></td>
<td align="center"><code>HashMap</code></td>
<td align="center"><code>Java 1.8</code> ä¹‹å‰é‡‡ç”¨<strong>åˆ†æ®µé”æœºåˆ¶</strong>ç»†åŒ–é”ç²’åº¦ï¼Œé™ä½é˜»å¡ï¼Œä»è€Œæé«˜å¹¶å‘æ€§ï¼›<code>Java 1.8</code> ä¹‹ååŸºäº <code>CAS</code> å®ç°ã€‚</td>
</tr>
<tr>
<td align="center"><code>ConcurrentSkipListMap</code></td>
<td align="center"><code>SortedMap</code></td>
<td align="center">åŸºäºè·³è¡¨å®ç°çš„</td>
</tr>
<tr>
<td align="center"><code>CopyOnWriteArrayList</code></td>
<td align="center"><code>ArrayList</code></td>
<td align="center">å†™æ—¶å¤åˆ¶</td>
</tr>
<tr>
<td align="center"><code>CopyOnWriteArraySet</code></td>
<td align="center"><code>Set</code></td>
<td align="center">åŸºäº <code>CopyOnWriteArrayList</code> å®ç°ã€‚</td>
</tr>
<tr>
<td align="center"><code>ConcurrentSkipListSet</code></td>
<td align="center"><code>SortedSet</code></td>
<td align="center">åŸºäº <code>ConcurrentSkipListMap</code> å®ç°ã€‚</td>
</tr>
<tr>
<td align="center"><code>ConcurrentLinkedQueue</code></td>
<td align="center"><code>Queue</code></td>
<td align="center">çº¿ç¨‹å®‰å…¨çš„æ— ç•Œé˜Ÿåˆ—ã€‚åº•å±‚é‡‡ç”¨å•é“¾è¡¨ã€‚æ”¯æŒ <code>FIFO</code>ã€‚</td>
</tr>
<tr>
<td align="center"><code>ConcurrentLinkedDeque</code></td>
<td align="center"><code>Deque</code></td>
<td align="center">çº¿ç¨‹å®‰å…¨çš„æ— ç•ŒåŒç«¯é˜Ÿåˆ—ã€‚åº•å±‚é‡‡ç”¨åŒå‘é“¾è¡¨ã€‚æ”¯æŒ <code>FIFO</code> å’Œ <code>FILO</code>ã€‚</td>
</tr>
<tr>
<td align="center"><code>ArrayBlockingQueue</code></td>
<td align="center"><code>Queue</code></td>
<td align="center">æ•°ç»„å®ç°çš„é˜»å¡é˜Ÿåˆ—ã€‚</td>
</tr>
<tr>
<td align="center"><code>LinkedBlockingQueue</code></td>
<td align="center"><code>Queue</code></td>
<td align="center">é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ã€‚</td>
</tr>
<tr>
<td align="center"><code>LinkedBlockingDeque</code></td>
<td align="center"><code>Deque</code></td>
<td align="center">åŒå‘é“¾è¡¨å®ç°çš„åŒç«¯é˜»å¡é˜Ÿåˆ—ã€‚</td>
</tr>
</tbody></table>
<h1 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a><code>ConcurrentHashMap</code></h1><blockquote>
<p><code>ConcurrentHashMap</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ <code>HashMap</code> ï¼Œç”¨äºæ›¿ä»£ <code>Hashtable</code>ã€‚</p>
</blockquote>
<h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><p><code>ConcurrentHashMap</code> å®ç°äº† <code>ConcurrentMap</code> æ¥å£ï¼Œè€Œ <code>ConcurrentMap</code> æ¥å£æ‰©å±•äº† <code>Map</code> æ¥å£ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcurrentHashMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;</span>
<span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">ConcurrentMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;, <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-comment">// ...</span>
&#125;</code></pre>

<p><code>ConcurrentHashMap</code> çš„å®ç°åŒ…å«äº† <code>HashMap</code> æ‰€æœ‰çš„åŸºæœ¬ç‰¹æ€§ï¼Œå¦‚ï¼šæ•°æ®ç»“æ„ã€è¯»å†™ç­–ç•¥ç­‰ã€‚</p>
<p><code>ConcurrentHashMap</code> æ²¡æœ‰å®ç°å¯¹ <code>Map</code> åŠ é”ä»¥æä¾›ç‹¬å è®¿é—®ã€‚å› æ­¤æ— æ³•é€šè¿‡åœ¨å®¢æˆ·ç«¯åŠ é”çš„æ–¹å¼æ¥åˆ›å»ºæ–°çš„åŸå­æ“ä½œã€‚ä½†æ˜¯ï¼Œä¸€äº›å¸¸è§çš„å¤åˆæ“ä½œï¼Œå¦‚ï¼šâ€œè‹¥æ²¡æœ‰åˆ™æ·»åŠ â€ã€â€œè‹¥ç›¸ç­‰åˆ™ç§»é™¤â€ã€â€œè‹¥ç›¸ç­‰åˆ™æ›¿æ¢â€ï¼Œéƒ½å·²ç»å®ç°ä¸ºåŸå­æ“ä½œï¼Œå¹¶ä¸”æ˜¯å›´ç»• <code>ConcurrentMap</code> çš„æ‰©å±•æ¥å£è€Œå®ç°ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ConcurrentMap</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>&#123;

    <span class="hljs-comment">// ä»…å½“ K æ²¡æœ‰ç›¸åº”çš„æ˜ å°„å€¼æ‰æ’å…¥</span>
    <span class="hljs-function">V <span class="hljs-title">putIfAbsent</span><span class="hljs-params">(K key, V value)</span></span>;

    <span class="hljs-comment">// ä»…å½“ K è¢«æ˜ å°„åˆ° V æ—¶æ‰ç§»é™¤</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">remove</span><span class="hljs-params">(Object key, Object value)</span></span>;

    <span class="hljs-comment">// ä»…å½“ K è¢«æ˜ å°„åˆ° oldValue æ—¶æ‰æ›¿æ¢ä¸º newValue</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">replace</span><span class="hljs-params">(K key, V oldValue, V newValue)</span></span>;

    <span class="hljs-comment">// ä»…å½“ K è¢«æ˜ å°„åˆ°æŸä¸ªå€¼æ—¶æ‰æ›¿æ¢ä¸º newValue</span>
    <span class="hljs-function">V <span class="hljs-title">replace</span><span class="hljs-params">(K key, V value)</span></span>;
&#125;</code></pre>
<p>ä¸åŒäº <code>Hashtable</code>ï¼Œ<code>ConcurrentHashMap</code> æä¾›çš„è¿­ä»£å™¨ä¸ä¼šæŠ›å‡º <code>ConcurrentModificationException</code>ï¼Œå› æ­¤ä¸éœ€è¦åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å¯¹å®¹å™¨åŠ é”ã€‚</p>
<blockquote>
<p>ğŸ”” æ³¨æ„ï¼šä¸€äº›éœ€è¦å¯¹æ•´ä¸ª <code>Map</code> è¿›è¡Œè®¡ç®—çš„æ–¹æ³•ï¼Œå¦‚ <code>size</code> å’Œ <code>isEmpty</code> ï¼Œç”±äºè¿”å›çš„ç»“æœåœ¨è®¡ç®—æ—¶å¯èƒ½å·²ç»è¿‡æœŸï¼Œæ‰€ä»¥å¹¶éå®æ—¶çš„ç²¾ç¡®å€¼ã€‚è¿™æ˜¯ä¸€ç§ç­–ç•¥ä¸Šçš„æƒè¡¡ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œè¿™ç±»æ–¹æ³•ç”±äºæ€»åœ¨ä¸æ–­å˜åŒ–ï¼Œæ‰€ä»¥è·å–å…¶å®æ—¶ç²¾ç¡®å€¼çš„æ„ä¹‰ä¸å¤§ã€‚<code>ConcurrentHashMap</code> å¼±åŒ–è¿™ç±»æ–¹æ³•ï¼Œä»¥æ¢å–æ›´é‡è¦æ“ä½œï¼ˆå¦‚ï¼š<code>get</code>ã€<code>put</code>ã€<code>containesKey</code>ã€<code>remove</code> ç­‰ï¼‰çš„æ€§èƒ½ã€‚</p>
</blockquote>
<h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p>åŒ <code>HashMap</code></p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><code>ConcurrentHashMap</code> åœ¨ <code>Java 1.8</code> ä¹‹å‰å’Œ <code>Java 1.8</code> ä¹‹åçš„å®ç°æœ‰å¾ˆå¤§å·®å¼‚ï¼š</p>
<ul>
<li><code>Java 1.8</code> ä¹‹å‰é‡‡ç”¨<strong>åˆ†æ®µé”æœºåˆ¶</strong>ç»†åŒ–é”ç²’åº¦ï¼Œé™ä½é˜»å¡ï¼Œä»è€Œæé«˜å¹¶å‘æ€§ã€‚</li>
<li><code>Java 1.8</code> ä¹‹ååŸºäº <code>CAS</code> å®ç°ã€‚</li>
</ul>
<h3 id="Java-1-7-çš„å®ç°"><a href="#Java-1-7-çš„å®ç°" class="headerlink" title="Java 1.7 çš„å®ç°"></a>Java 1.7 çš„å®ç°</h3><p>æ¯ä¸€ä¸ª <code>segment</code> éƒ½æ˜¯ä¸€ä¸ª <code>HashEntry&lt;K,V&gt;[] table</code>ï¼Œ <code>table</code> ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ª <code>HashEntry</code> çš„å•å‘é˜Ÿåˆ—ã€‚æ¯”å¦‚ <code>table[3]</code> ä¸ºé¦–èŠ‚ç‚¹ï¼Œ<code>table[3]-&gt;next</code> ä¸ºèŠ‚ç‚¹ <code>1</code>ï¼Œä¹‹åä¸ºèŠ‚ç‚¹ <code>2</code>ï¼Œä¾æ¬¡ç±»æ¨ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcurrentHashMap</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMap</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt;</span>
<span class="hljs-class">        <span class="hljs-keyword">implements</span> <span class="hljs-title">ConcurrentMap</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt;, <span class="hljs-title">Serializable</span> </span>&#123;

    <span class="hljs-comment">// å°†æ•´ä¸ª hashmap åˆ†æˆå‡ ä¸ªå°çš„ mapï¼Œæ¯ä¸ª segment éƒ½æ˜¯ä¸€ä¸ªé”ï¼›ä¸ hashtable ç›¸æ¯”ï¼Œè¿™ä¹ˆè®¾è®¡çš„ç›®çš„æ˜¯å¯¹äº put, remove ç­‰æ“ä½œï¼Œå¯ä»¥å‡å°‘å¹¶å‘å†²çªï¼Œå¯¹</span>
    <span class="hljs-comment">// ä¸å±äºåŒä¸€ä¸ªç‰‡æ®µçš„èŠ‚ç‚¹å¯ä»¥å¹¶å‘æ“ä½œï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½</span>
    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments;

    <span class="hljs-comment">// æœ¬è´¨ä¸Š Segment ç±»å°±æ˜¯ä¸€ä¸ªå°çš„ hashmapï¼Œé‡Œé¢ table æ•°ç»„å­˜å‚¨äº†å„ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼Œç»§æ‰¿äº† ReentrantLock, å¯ä»¥ä½œä¸ºäº’æ–¥é”ä½¿ç”¨</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Segment</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
        <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;
        <span class="hljs-keyword">transient</span> <span class="hljs-keyword">int</span> count;
    &#125;

    <span class="hljs-comment">// åŸºæœ¬èŠ‚ç‚¹ï¼Œå­˜å‚¨ Key, Value å€¼</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HashEntry</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; </span>&#123;
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> hash;
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V value;
        <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt; next;
    &#125;
&#125;</code></pre>

<h3 id="Java-1-8-çš„å®ç°"><a href="#Java-1-8-çš„å®ç°" class="headerlink" title="Java 1.8 çš„å®ç°"></a>Java 1.8 çš„å®ç°</h3><p><code>JDK 8</code> ä¸­ä¸»è¦åšäº† 2 æ–¹é¢çš„æ”¹è¿›</p>
<ul>
<li><p>å–æ¶ˆ <code>segments</code> å­—æ®µï¼Œç›´æ¥é‡‡ç”¨ <code>transient volatile HashEntry&lt;K,V&gt;[] table</code> ä¿å­˜æ•°æ®ï¼Œé‡‡ç”¨ <code>table</code> æ•°ç»„å…ƒç´ ä½œä¸ºé”ï¼Œä»è€Œå®ç°äº†å¯¹æ¯ä¸€è¡Œæ•°æ®è¿›è¡ŒåŠ é”ï¼Œè¿›ä¸€æ­¥å‡å°‘å¹¶å‘å†²çªçš„æ¦‚ç‡ã€‚</p>
</li>
<li><p>å°†åŸå…ˆ <strong>æ•°ç»„ï¼‹å•é“¾è¡¨</strong> çš„æ•°æ®ç»“æ„ï¼Œå˜æ›´ä¸º <strong>æ•°ç»„ï¼‹å•é“¾è¡¨ï¼‹çº¢é»‘æ ‘</strong> çš„ç»“æ„ã€‚å¯¹äº <code>hash</code> è¡¨æ¥è¯´ï¼Œæœ€æ ¸å¿ƒçš„èƒ½åŠ›åœ¨äºå°† <code>key hash</code> ä¹‹åèƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨æ•°ç»„ä¸­ã€‚å¦‚æœ <code>hash</code> ä¹‹åæ•£åˆ—çš„å¾ˆå‡åŒ€ï¼Œé‚£ä¹ˆ <code>table</code> æ•°ç»„ä¸­çš„æ¯ä¸ªé˜Ÿåˆ—é•¿åº¦ä¸»è¦ä¸º <code>0</code> æˆ–è€… <code>1</code>ã€‚ä½†å®é™…æƒ…å†µå¹¶éæ€»æ˜¯å¦‚æ­¤ç†æƒ³ï¼Œè™½ç„¶ <code>ConcurrentHashMap</code> ç±»é»˜è®¤çš„åŠ è½½å› å­ä¸º <code>0.75</code>ï¼Œä½†æ˜¯åœ¨æ•°æ®é‡è¿‡å¤§æˆ–è€…è¿æ°”ä¸ä½³çš„æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨ä¸€äº›é˜Ÿåˆ—é•¿åº¦è¿‡é•¿çš„æƒ…å†µï¼Œå¦‚æœè¿˜æ˜¯é‡‡ç”¨å•å‘åˆ—è¡¨æ–¹å¼ï¼Œé‚£ä¹ˆæŸ¥è¯¢æŸä¸ªèŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦ä¸º <code>O(n)</code>ï¼›å› æ­¤ï¼Œå¯¹äºä¸ªæ•°è¶…è¿‡ <code>8</code>(é»˜è®¤å€¼)çš„åˆ—è¡¨ï¼Œ<code>JDK 1.8</code> ä¸­é‡‡ç”¨äº†çº¢é»‘æ ‘çš„ç»“æ„ï¼Œé‚£ä¹ˆæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ° <code>O(logN)</code>ï¼Œå¯ä»¥æ”¹è¿›æ€§èƒ½ã€‚</p>
</li>
</ul>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">final</span> V <span class="hljs-title">putVal</span><span class="hljs-params">(K key, V value, <span class="hljs-keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span> || value == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();
    <span class="hljs-keyword">int</span> hash = spread(key.hashCode());
    <span class="hljs-keyword">int</span> binCount = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;
        Node&lt;K,V&gt; f; <span class="hljs-keyword">int</span> n, i, fh;
        <span class="hljs-comment">// å¦‚æœ table ä¸ºç©ºï¼Œåˆå§‹åŒ–ï¼›å¦åˆ™ï¼Œæ ¹æ® hash å€¼è®¡ç®—å¾—åˆ°æ•°ç»„ç´¢å¼•iï¼Œå¦‚æœ tab[i] ä¸ºç©ºï¼Œç›´æ¥æ–°å»ºèŠ‚ç‚¹ Node å³å¯ã€‚æ³¨ï¼štab[i] å®è´¨ä¸ºé“¾è¡¨æˆ–è€…çº¢é»‘æ ‘çš„é¦–èŠ‚ç‚¹ã€‚</span>
        <span class="hljs-keyword">if</span> (tab == <span class="hljs-keyword">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)
            tab = initTable();
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-keyword">null</span>,
                         <span class="hljs-keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="hljs-keyword">null</span>)))
                <span class="hljs-keyword">break</span>;                   <span class="hljs-comment">// no lock when adding to empty bin</span>
        &#125;
        <span class="hljs-comment">// å¦‚æœ tab[i] ä¸ä¸ºç©ºå¹¶ä¸” hash å€¼ä¸º MOVEDï¼Œè¯´æ˜è¯¥é“¾è¡¨æ­£åœ¨è¿›è¡Œ transfer æ“ä½œï¼Œè¿”å›æ‰©å®¹å®Œæˆåçš„ tableã€‚</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            tab = helpTransfer(tab, f);
        <span class="hljs-keyword">else</span> &#123;
            V oldVal = <span class="hljs-keyword">null</span>;
            <span class="hljs-comment">// é’ˆå¯¹é¦–ä¸ªèŠ‚ç‚¹è¿›è¡ŒåŠ é”æ“ä½œï¼Œè€Œä¸æ˜¯ segmentï¼Œè¿›ä¸€æ­¥å‡å°‘çº¿ç¨‹å†²çª</span>
            <span class="hljs-keyword">synchronized</span> (f) &#123;
                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) &#123;
                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) &#123;
                        binCount = <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;
                            K ek;
                            <span class="hljs-comment">// å¦‚æœåœ¨é“¾è¡¨ä¸­æ‰¾åˆ°å€¼ä¸º key çš„èŠ‚ç‚¹ eï¼Œç›´æ¥è®¾ç½® e.val = value å³å¯ã€‚</span>
                            <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;
                                ((ek = e.key) == key ||
                                 (ek != <span class="hljs-keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;
                                oldVal = e.val;
                                <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                    e.val = value;
                                <span class="hljs-keyword">break</span>;
                            &#125;
                            <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°å€¼ä¸º key çš„èŠ‚ç‚¹ï¼Œç›´æ¥æ–°å»º Node å¹¶åŠ å…¥é“¾è¡¨å³å¯ã€‚</span>
                            Node&lt;K,V&gt; pred = e;
                            <span class="hljs-keyword">if</span> ((e = e.next) == <span class="hljs-keyword">null</span>) &#123;
                                pred.next = <span class="hljs-keyword">new</span> Node&lt;K,V&gt;(hash, key,
                                                          value, <span class="hljs-keyword">null</span>);
                                <span class="hljs-keyword">break</span>;
                            &#125;
                        &#125;
                    &#125;
                    <span class="hljs-comment">// å¦‚æœé¦–èŠ‚ç‚¹ä¸º TreeBin ç±»å‹ï¼Œè¯´æ˜ä¸ºçº¢é»‘æ ‘ç»“æ„ï¼Œæ‰§è¡Œ utTreeVal æ“ä½œã€‚</span>
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) &#123;
                        Node&lt;K,V&gt; p;
                        binCount = <span class="hljs-number">2</span>;
                        <span class="hljs-keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,
                                                       value)) != <span class="hljs-keyword">null</span>) &#123;
                            oldVal = p.val;
                            <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                p.val = value;
                        &#125;
                    &#125;
                &#125;
            &#125;
            <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) &#123;
                <span class="hljs-comment">// å¦‚æœèŠ‚ç‚¹æ•° &gt;ï¼8ï¼Œé‚£ä¹ˆè½¬æ¢é“¾è¡¨ç»“æ„ä¸ºçº¢é»‘æ ‘ç»“æ„ã€‚</span>
                <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)
                    treeifyBin(tab, i);
                <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-keyword">null</span>)
                    <span class="hljs-keyword">return</span> oldVal;
                <span class="hljs-keyword">break</span>;
            &#125;
        &#125;
    &#125;
    <span class="hljs-comment">// è®¡æ•°å¢åŠ 1ï¼Œæœ‰å¯èƒ½è§¦å‘ transfer æ“ä½œ(æ‰©å®¹)ã€‚</span>
    addCount(<span class="hljs-number">1L</span>, binCount);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
&#125;</code></pre>

<h1 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a><code>CopyOnWriteArrayList</code></h1><p>æ¯ä¸ª <code>CopyOnWriteArrayList</code> å¯¹è±¡é‡Œæœ‰ä¸€ä¸ª <code>array</code> æ•°ç»„ç”¨æ¥å­˜æ”¾å…·ä½“å…ƒç´ ã€‚<code>ReentrantLock</code> ç‹¬å é”ç”¨æ¥ä¿è¯åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹ <code>array</code> è¿›è¡Œä¿®æ”¹ã€‚<br><img src="https://raw.githubusercontent.com/LikaiLee/likailee.github.io/img/20200724151232.png" srcset="/img/loading.gif" alt=""></p>
<h2 id="è¦ç‚¹"><a href="#è¦ç‚¹" class="headerlink" title="è¦ç‚¹"></a>è¦ç‚¹</h2><ul>
<li><p>å¥½å¤„ï¼š<strong>ä»»ä½•çš„è¯»æ“ä½œéƒ½ä¸ç”¨åŠ é”</strong>ï¼Œè€Œä¸”ä¿è¯è¯»å–åˆ°çš„æ˜¯è¯»é‚£ä¸€åˆ» <code>List</code> å®Œæ•´çš„å¿«ç…§æ•°æ®ã€‚ç”±äºè¯»æ“ä½œæ— æ³•æ„ŸçŸ¥æœ€æ–°æ­£åœ¨å˜åŒ–çš„æ•°æ®ï¼Œæ‰€ä»¥ <code>CopyOnWriteArrayList</code> æ˜¯<strong>å¼±ä¸€è‡´æ€§</strong>çš„ã€‚</p>
</li>
<li><p>å†™æ—¶å¤åˆ¶æŠ€æœ¯å› ä¸ºæ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦å®Œæ•´æ‹·è´ä¸€æ¬¡åº•å±‚æ•°ç»„ï¼Œæ‰€ä»¥æœ‰é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œä½†æ˜¯ç‰¹åˆ«é€‚ç”¨äº<strong>è¯»å¤šå†™å°‘</strong>çš„æ•°æ®è®¿é—®åœºæ™¯ã€‚</p>
</li>
</ul>
<h2 id="å¼±ä¸€è‡´æ€§é—®é¢˜"><a href="#å¼±ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="å¼±ä¸€è‡´æ€§é—®é¢˜"></a>å¼±ä¸€è‡´æ€§é—®é¢˜</h2><p>çº¿ç¨‹1åœ¨æ‰§è¡Œå®Œæ­¥éª¤ <code>A</code> åï¼Œæ‰§è¡Œæ­¥éª¤ <code>B</code> å‰ï¼Œçº¿ç¨‹2è¿›è¡Œäº† <code>remove</code> æ“ä½œã€‚<br>è™½ç„¶çº¿ç¨‹2å·²ç»åˆ é™¤äº† <code>index</code> å¤„çš„å…ƒç´ ï¼Œä½†ç”±äº <code>array</code>æŒ‡å‘çš„æ•°ç»„å¼•ç”¨è®¡æ•°ä¸º 1 è€Œä¸æ˜¯ 0ï¼Œä»ä¼šè¿”å› <code>index</code> å¤„çš„å…ƒç´ ã€‚</p>
<h2 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h2><p>å…ˆå°†åŸå®¹å™¨ copy ä¸€ä»½ï¼Œç„¶ååœ¨æ–°å‰¯æœ¬ä¸Šæ‰§è¡Œå†™æ“ä½œï¼Œä¹‹åå†åˆ‡æ¢å¼•ç”¨ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;
    <span class="hljs-comment">// 1.è·å–ç‹¬å é”</span>
    <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock;
    lock.lock();
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">// 2.è·å– array æ•°ç»„</span>
        Object[] elements = getArray();
        <span class="hljs-keyword">int</span> len = elements.length;
        <span class="hljs-comment">// 3.å¤åˆ¶ array åˆ°æ–°æ•°ç»„</span>
        Object[] newElements = Arrays.copyOf(elements, len + <span class="hljs-number">1</span>);
        <span class="hljs-comment">// 4.æ·»åŠ å…ƒç´ åˆ°æ–°æ•°ç»„</span>
        newElements[len] = e;
        <span class="hljs-comment">// 5.ç”¨æ–°æ•°ç»„æ›¿æ¢åŸæ•°ç»„</span>
        setArray(newElements);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    &#125; <span class="hljs-keyword">finally</span> &#123;
        <span class="hljs-comment">// 6.é‡Šæ”¾é”</span>
        lock.unlock();
    &#125;
&#125;</code></pre>

<h2 id="åˆ é™¤å…ƒç´ "><a href="#åˆ é™¤å…ƒç´ " class="headerlink" title="åˆ é™¤å…ƒç´ "></a>åˆ é™¤å…ƒç´ </h2><p>å°†é™¤è¦åˆ é™¤å…ƒç´ ä¹‹å¤–çš„å…¶ä»–å…ƒç´ æ‹·è´åˆ°æ–°å‰¯æœ¬ä¸­ï¼Œç„¶ååˆ‡æ¢å¼•ç”¨ï¼Œå°†åŸå®¹å™¨å¼•ç”¨æŒ‡å‘æ–°å‰¯æœ¬ã€‚åŒå±å†™æ“ä½œï¼Œéœ€è¦åŠ é”ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">remove</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123;
    <span class="hljs-comment">// è·å–ç‹¬å é”</span>
    <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock;
    lock.lock();
    <span class="hljs-keyword">try</span> &#123;
        Object[] elements = getArray();
        <span class="hljs-keyword">int</span> len = elements.length;
        E oldValue = get(elements, index);
        <span class="hljs-comment">// éœ€è¦ç§»åŠ¨çš„å…ƒç´ ä¸ªæ•°</span>
        <span class="hljs-keyword">int</span> numMoved = len - index - <span class="hljs-number">1</span>;
        <span class="hljs-comment">// è‹¥åˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ </span>
        <span class="hljs-keyword">if</span> (numMoved == <span class="hljs-number">0</span>)
           <span class="hljs-comment">// æ‹·è´å‰len-1ä¸ªæ•°æ®åˆ°æ–°å‰¯æœ¬ä¸Šï¼Œå†åˆ‡æ¢å¼•ç”¨</span>
           setArray(Arrays.copyOf(elements, len - <span class="hljs-number">1</span>));
        <span class="hljs-keyword">else</span> &#123;
            Object[] newElements = <span class="hljs-keyword">new</span> Object[len - <span class="hljs-number">1</span>];
            <span class="hljs-comment">// åˆ†ä¸¤å—å¤åˆ¶åˆ°æ–°æ•°ç»„</span>
            System.arraycopy(elements, <span class="hljs-number">0</span>, newElements, <span class="hljs-number">0</span>, index);
            System.arraycopy(elements, index + <span class="hljs-number">1</span>, newElements, index,
                             numMoved);
            <span class="hljs-comment">// è®¾ç½®æ–°æ•°ç»„</span>
            setArray(newElements);
        &#125;
        <span class="hljs-keyword">return</span> oldValue;
    &#125; <span class="hljs-keyword">finally</span> &#123;
        <span class="hljs-comment">// é‡Šæ”¾é”</span>
        lock.unlock();
    &#125;
&#125;</code></pre>

<h2 id="è¯»æ“ä½œ"><a href="#è¯»æ“ä½œ" class="headerlink" title="è¯»æ“ä½œ"></a>è¯»æ“ä½œ</h2><p><code>E get(int index)</code><br>è¯»æ“ä½œæ˜¯ä¸ç”¨åŠ é”çš„ï¼Œæ€§èƒ½å¾ˆé«˜ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123;
    <span class="hljs-keyword">return</span> get(getArray(), index);
&#125;
<span class="hljs-comment">// A.è·å– array æ•°ç»„</span>
<span class="hljs-keyword">final</span> Object[] getArray() &#123;
    <span class="hljs-keyword">return</span> array;
&#125;
<span class="hljs-comment">// B.é€šè¿‡ä¸‹æ ‡è®¿é—®æŒ‡å®šä½ç½®çš„æ•°ç»„å…ƒç´ </span>
<span class="hljs-function"><span class="hljs-keyword">private</span> E <span class="hljs-title">get</span><span class="hljs-params">(Object[] a, <span class="hljs-keyword">int</span> index)</span> </span>&#123;
    <span class="hljs-keyword">return</span> (E) a[index];
&#125;</code></pre>

<h2 id="ä¿®æ”¹æŒ‡å®šå…ƒç´ "><a href="#ä¿®æ”¹æŒ‡å®šå…ƒç´ " class="headerlink" title="ä¿®æ”¹æŒ‡å®šå…ƒç´ "></a>ä¿®æ”¹æŒ‡å®šå…ƒç´ </h2><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index, E element)</span> </span>&#123;
    <span class="hljs-comment">// è·å–ç‹¬å é”</span>
    <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">this</span>.lock;
    lock.lock();
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">// è·å– array æ•°ç»„</span>
        Object[] elements = getArray();
        <span class="hljs-comment">// æ‰¾åˆ°åŸä½ç½®ä¸Šçš„å€¼</span>
        E oldValue = get(elements, index);

        <span class="hljs-keyword">if</span> (oldValue != element) &#123;
            <span class="hljs-keyword">int</span> len = elements.length;
            <span class="hljs-comment">// å¤åˆ¶ array åˆ°æ–°æ•°ç»„</span>
            Object[] newElements = Arrays.copyOf(elements, len);
            <span class="hljs-comment">// è®¾ç½® index ä½ç½®çš„å…ƒç´ </span>
            newElements[index] = element;
            <span class="hljs-comment">// ç”¨æ–°æ•°ç»„æ›¿æ¢æ—§æ•°ç»„</span>
            setArray(newElements);
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-comment">// Not quite a no-op; ensures volatile write semantics</span>
            setArray(elements);
        &#125;
        <span class="hljs-keyword">return</span> oldValue;
    &#125; <span class="hljs-keyword">finally</span> &#123;
        <span class="hljs-comment">// é‡Šæ”¾é”</span>
        lock.unlock();
    &#125;
&#125;</code></pre>

<h1 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a><code>BlockingQueue</code></h1><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BlockingQueue</span>&lt;<span class="hljs-title">E</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">Queue</span>&lt;<span class="hljs-title">E</span>&gt; </span>&#123;&#125;</code></pre>
<p>åœ¨ <code>BlockingQueue</code> ä¸­ï¼Œå¦‚æœè·å–é˜Ÿåˆ—å…ƒç´ ä½†æ˜¯é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¼šé˜»å¡ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ å†è¿”å›ï¼›å¦‚æœæ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œé‚£ä¹ˆç­‰åˆ°é˜Ÿåˆ—å¯ä»¥æ”¾å…¥æ–°å…ƒç´ æ—¶å†æ”¾å…¥ã€‚</p>
<p><code>BlockingQueue</code> å¯¹æ’å…¥æ“ä½œã€ç§»é™¤æ“ä½œã€è·å–å…ƒç´ æ“ä½œæä¾›äº†å››ç§ä¸åŒçš„æ–¹æ³•ç”¨äºä¸åŒçš„åœºæ™¯ä¸­ä½¿ç”¨ï¼š</p>
<p>æŠ›å‡ºå¼‚å¸¸ï¼›</p>
<ul>
<li>è¿”å›ç‰¹æ®Šå€¼ï¼ˆ<code>null</code> æˆ– <code>true</code>/<code>false</code>ï¼Œå–å†³äºå…·ä½“çš„æ“ä½œï¼‰ï¼›</li>
<li>é˜»å¡ç­‰å¾…æ­¤æ“ä½œï¼Œç›´åˆ°è¿™ä¸ªæ“ä½œæˆåŠŸï¼›</li>
<li>é˜»å¡ç­‰å¾…æ­¤æ“ä½œï¼Œç›´åˆ°æˆåŠŸæˆ–è€…è¶…æ—¶æŒ‡å®šæ—¶é—´ã€‚<br>æ€»ç»“å¦‚ä¸‹ï¼š</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Operation</th>
<th align="center">Throws exception</th>
<th align="center">Special value</th>
<th align="center">Blocks</th>
<th align="center">Times out</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Insert</td>
<td align="center">add(e)</td>
<td align="center">offer(e)</td>
<td align="center">put(e)</td>
<td align="center">offer(e, time, unit)</td>
</tr>
<tr>
<td align="center">Remove</td>
<td align="center">remove()</td>
<td align="center">poll()</td>
<td align="center">take()</td>
<td align="center">poll(time, unit)</td>
</tr>
<tr>
<td align="center">Examine</td>
<td align="center">element()</td>
<td align="center">peek()</td>
<td align="center">not applicable</td>
<td align="center">not applicable</td>
</tr>
</tbody></table>
<p><code>BlockingQueue</code> çš„å„ä¸ªå®ç°ç±»éƒ½éµå¾ªäº†è¿™äº›è§„åˆ™ã€‚</p>
<p><code>BlockingQueue</code> ä¸æ¥å— <code>null</code> å€¼å…ƒç´ ã€‚</p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%B9%B6%E5%8F%91/">å¹¶å‘</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E5%B9%B6%E5%8F%91/">å¹¶å‘</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%AE%B9%E5%99%A8/">å®¹å™¨</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/07/27/concurrent-threadpool/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">å¹¶å‘-çº¿ç¨‹æ± </span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/07/21/concurrent-atomic/">
                        <span class="hidden-mobile">å¹¶å‘-åŸå­ç±»</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <!-- <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> -->
      Crafted with
      <i class="iconfont icon-love" style="color: #f30;"></i>
      by <a href="https://github.com/likailee" target="_blank" rel="noopener">Likai Lee</a>
      | &copy; 2017 - 2020
      <!-- <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a> -->
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>





  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>

















  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?66c61a5fd59052d1b39d89c246846ae5";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





</body>
</html>
